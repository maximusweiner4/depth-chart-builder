<!DOCTYPE html>
<html lang="en" style="color-scheme: light dark;">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#1a1a2e" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#1f2937" media="(prefers-color-scheme: dark)">
  <meta name="description" content="Build and customize interactive college football depth charts. Import rosters, assign players, track injuries, and share your depth chart.">
  <meta property="og:title" content="College Football Depth Chart Builder">
  <meta property="og:description" content="Build and customize interactive college football depth charts with real roster data.">
  <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="College Football Depth Chart Builder">
  <meta name="twitter:description" content="Build and customize interactive college football depth charts with real roster data.">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèà</text></svg>">
  <title>College Football Depth Chart Builder</title>
  <link rel="stylesheet" href="/dist/tailwind.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --grain-opacity: 0.03;
    }

    body {
      font-family: 'Plus Jakarta Sans', sans-serif;
      letter-spacing: -0.01em;
    }
    .font-display {
      font-family: 'Bebas Neue', sans-serif;
      letter-spacing: 0.04em;
    }

    /* Grain texture overlay for depth */
    .grain-overlay::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      opacity: var(--grain-opacity);
      z-index: 9999;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
    }

    /* Animations - simple opacity-only to prevent overflow */
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes savedPop {
      0% { opacity: 0; }
      100% { opacity: 1; }
    }
    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .animate-spin { animation: spin 1s linear infinite; }
    .animate-fadeIn { animation: fadeIn 0.2s ease-out forwards; }
    .animate-savedPop { animation: savedPop 0.3s ease-out; }

    /* Respect reduced motion preference */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* Focus visible styles */
    input:focus-visible, textarea:focus-visible, select:focus-visible {
      outline: 2px solid var(--primary-color, #3b82f6);
      outline-offset: 2px;
    }

    /* Tabular numbers for stats */
    .tabular-nums {
      font-variant-numeric: tabular-nums;
    }

    /* Loading skeleton */
    .skeleton {
      background: linear-gradient(90deg, #e0e0e0 25%, #f0f0f0 50%, #e0e0e0 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }

    .dark .skeleton {
      background: linear-gradient(90deg, #374151 25%, #4B5563 50%, #374151 75%);
      background-size: 200% 100%;
    }

    /* Drag and drop styles */
    .dragging {
      opacity: 0.5;
    }
    .drag-over {
      box-shadow: 0 0 0 3px #FCD34D;
    }

    /* Tooltip styles */
    .tooltip { position: relative; }
    .tooltip::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      z-index: 100;
      margin-bottom: 8px;
    }
    .tooltip:hover::after {
      opacity: 1;
    }

    /* Print styles */
    @media print {
      .no-print { display: none !important; }
      body { background: white !important; }
      .grain-overlay::before { display: none; }
    }

    /* Field lines with enhanced contrast */
    .field-lines {
      background-image:
        repeating-linear-gradient(
          0deg,
          transparent,
          transparent calc(10% - 1px),
          rgba(255,255,255,0.12) calc(10% - 1px),
          rgba(255,255,255,0.12) 10%
        ),
        linear-gradient(180deg, rgba(0,0,0,0.1) 0%, transparent 20%, transparent 80%, rgba(0,0,0,0.15) 100%);
    }

    /* Position card hover */
    .position-card {
      transition: box-shadow 0.15s ease;
    }
    .position-card:hover {
      z-index: 10;
    }
    .position-card:hover .position-card-inner {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    /* Button hover effects */
    .btn-hover {
      transition: background-color 0.15s ease;
    }
    .btn-hover:active {
      transform: translateY(0);
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: transparent; border-radius: 4px; }
    ::-webkit-scrollbar-thumb {
      background: var(--primary-color, #1a1a2e);
      border-radius: 4px;
      border: 2px solid transparent;
      background-clip: padding-box;
    }
    ::-webkit-scrollbar-thumb:hover { background: var(--primary-light, #2a2a4e); }

    /* Thin scrollbar for modal scroll areas */
    .scrollbar-thin::-webkit-scrollbar { width: 6px; }
    .scrollbar-thin {
      scrollbar-width: thin;
      scrollbar-color: var(--primary-color, #1a1a2e) transparent;
    }

    /* Header gradient accent */
    .header-accent {
      position: relative;
      overflow: hidden;
    }
    .header-accent::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, transparent, var(--accent-color, rgba(255,255,255,0.5)), transparent);
    }

    /* Pill/badge hover glow */
    .pill-glow:hover {
      box-shadow: 0 0 0 2px var(--glow-color, rgba(59, 130, 246, 0.5));
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
      .field-container { min-height: auto; padding: 1rem; }
      .position-card-inner {
        min-width: 56px !important;
        font-size: 9px;
      }
    }

    @media (max-width: 640px) and (orientation: portrait) {
      .field-view { display: none; }
      .mobile-list-view { display: block !important; }
      .mobile-controls-bar { display: block !important; }
      .desktop-only { display: none !important; }
    }

    .mobile-list-view { display: none; }
    .mobile-controls-bar { display: none; }
  </style>
</head>
<body class="min-h-screen transition-colors duration-300 grain-overlay">
  <div id="app"></div>

  <script>
    // LZString compression library (v1.5.0) - used for shareable URL compression
    var LZString=function(){var r=String.fromCharCode,o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",e={};function t(r,o){if(!e[r]){e[r]={};for(var n=0;n<r.length;n++)e[r][r.charAt(n)]=n}return e[r][o]}var i={compressToBase64:function(r){if(null==r)return"";var n=i._compress(r,6,function(r){return o.charAt(r)});switch(n.length%4){default:case 0:return n;case 1:return n+"===";case 2:return n+"==";case 3:return n+"="}},decompressFromBase64:function(r){return null==r?"":""==r?null:i._decompress(r.length,32,function(n){return t(o,r.charAt(n))})},compressToUTF16:function(o){return null==o?"":i._compress(o,15,function(o){return r(o+32)})+" "},decompressFromUTF16:function(r){return null==r?"":""==r?null:i._decompress(r.length,16384,function(o){return r.charCodeAt(o)-32})},compressToUint8Array:function(r){for(var o=i.compress(r),n=new Uint8Array(2*o.length),e=0,t=o.length;e<t;e++){var s=o.charCodeAt(e);n[2*e]=s>>>8,n[2*e+1]=s%256}return n},decompressFromUint8Array:function(o){if(null==o)return i.decompress(o);for(var n=new Array(o.length/2),e=0,t=n.length;e<t;e++)n[e]=256*o[2*e]+o[2*e+1];var s=[];return n.forEach(function(o){s.push(r(o))}),i.decompress(s.join(""))},compressToEncodedURIComponent:function(r){return null==r?"":i._compress(r,6,function(r){return n.charAt(r)})},decompressFromEncodedURIComponent:function(r){return null==r?"":""==r?null:(r=r.replace(/ /g,"+"),i._decompress(r.length,32,function(o){return t(n,r.charAt(o))}))},compress:function(o){return i._compress(o,16,function(o){return r(o)})},_compress:function(r,o,n){if(null==r)return"";var e,t,i,s={},u={},a="",p="",c="",l=2,f=3,h=2,d=[],m=0,v=0;for(i=0;i<r.length;i+=1)if(a=r.charAt(i),Object.prototype.hasOwnProperty.call(s,a)||(s[a]=f++,u[a]=!0),p=c+a,Object.prototype.hasOwnProperty.call(s,p))c=p;else{if(Object.prototype.hasOwnProperty.call(u,c)){if(c.charCodeAt(0)<256){for(e=0;e<h;e++)m<<=1,v==o-1?(v=0,d.push(n(m)),m=0):v++;for(t=c.charCodeAt(0),e=0;e<8;e++)m=m<<1|1&t,v==o-1?(v=0,d.push(n(m)),m=0):v++,t>>=1}else{for(t=1,e=0;e<h;e++)m=m<<1|t,v==o-1?(v=0,d.push(n(m)),m=0):v++,t=0;for(t=c.charCodeAt(0),e=0;e<16;e++)m=m<<1|1&t,v==o-1?(v=0,d.push(n(m)),m=0):v++,t>>=1}0==--l&&(l=Math.pow(2,h),h++),delete u[c]}else for(t=s[c],e=0;e<h;e++)m=m<<1|1&t,v==o-1?(v=0,d.push(n(m)),m=0):v++,t>>=1;0==--l&&(l=Math.pow(2,h),h++),s[p]=f++,c=String(a)}if(""!==c){if(Object.prototype.hasOwnProperty.call(u,c)){if(c.charCodeAt(0)<256){for(e=0;e<h;e++)m<<=1,v==o-1?(v=0,d.push(n(m)),m=0):v++;for(t=c.charCodeAt(0),e=0;e<8;e++)m=m<<1|1&t,v==o-1?(v=0,d.push(n(m)),m=0):v++,t>>=1}else{for(t=1,e=0;e<h;e++)m=m<<1|t,v==o-1?(v=0,d.push(n(m)),m=0):v++,t=0;for(t=c.charCodeAt(0),e=0;e<16;e++)m=m<<1|1&t,v==o-1?(v=0,d.push(n(m)),m=0):v++,t>>=1}0==--l&&(l=Math.pow(2,h),h++),delete u[c]}else for(t=s[c],e=0;e<h;e++)m=m<<1|1&t,v==o-1?(v=0,d.push(n(m)),m=0):v++,t>>=1;0==--l&&(l=Math.pow(2,h),h++)}for(t=2,e=0;e<h;e++)m=m<<1|1&t,v==o-1?(v=0,d.push(n(m)),m=0):v++,t>>=1;for(;;){if(m<<=1,v==o-1){d.push(n(m));break}v++}return d.join("")},decompress:function(r){return null==r?"":""==r?null:i._decompress(r.length,32768,function(o){return r.charCodeAt(o)})},_decompress:function(o,n,e){var t,i,s,u,a,p,c,l=[],f=4,h=4,d=3,m="",v=[],g={val:e(0),position:n,index:1};for(t=0;t<3;t+=1)l[t]=t;for(s=0,a=Math.pow(2,2),p=1;p!=a;)u=g.val&g.position,g.position>>=1,0==g.position&&(g.position=n,g.val=e(g.index++)),s|=(u>0?1:0)*p,p<<=1;switch(s){case 0:for(s=0,a=Math.pow(2,8),p=1;p!=a;)u=g.val&g.position,g.position>>=1,0==g.position&&(g.position=n,g.val=e(g.index++)),s|=(u>0?1:0)*p,p<<=1;c=r(s);break;case 1:for(s=0,a=Math.pow(2,16),p=1;p!=a;)u=g.val&g.position,g.position>>=1,0==g.position&&(g.position=n,g.val=e(g.index++)),s|=(u>0?1:0)*p,p<<=1;c=r(s);break;case 2:return""}for(l[3]=c,i=c,v.push(c);;){if(g.index>o)return"";for(s=0,a=Math.pow(2,d),p=1;p!=a;)u=g.val&g.position,g.position>>=1,0==g.position&&(g.position=n,g.val=e(g.index++)),s|=(u>0?1:0)*p,p<<=1;switch(c=s){case 0:for(s=0,a=Math.pow(2,8),p=1;p!=a;)u=g.val&g.position,g.position>>=1,0==g.position&&(g.position=n,g.val=e(g.index++)),s|=(u>0?1:0)*p,p<<=1;l[h++]=r(s),c=h-1,f--;break;case 1:for(s=0,a=Math.pow(2,16),p=1;p!=a;)u=g.val&g.position,g.position>>=1,0==g.position&&(g.position=n,g.val=e(g.index++)),s|=(u>0?1:0)*p,p<<=1;l[h++]=r(s),c=h-1,f--;break;case 2:return v.join("")}if(0==f&&(f=Math.pow(2,d),d++),l[c])m=l[c];else{if(c!==h)return null;m=i+i.charAt(0)}v.push(m),l[h++]=i+m.charAt(0),i=m,0==--f&&(f=Math.pow(2,d),d++)}}};return i}();"function"==typeof define&&define.amd?define(function(){return LZString}):"undefined"!=typeof module&&null!=module?module.exports=LZString:"undefined"!=typeof angular&&null!=angular&&angular.module("LZString",[]).factory("LZString",function(){return LZString});

    // HTML escaping utility to prevent XSS
    function escapeHtml(str) {
      if (str == null) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // Safe URL helper - blocks javascript: and data: protocols
    function safeUrl(url) {
      if (!url) return '';
      try {
        const parsed = new URL(url, window.location.origin);
        if (!['http:', 'https:'].includes(parsed.protocol)) return '';
        return escapeHtml(url);
      } catch {
        return '';
      }
    }

    // Position definitions
    // Formation definitions for offense and defense
    const FORMATIONS = {
      offense: {
        'spread': {
          name: 'Spread (10 Personnel)',
          description: '1 RB, 0 TE, 4 WR',
          positions: [
            { code: 'WR-X', name: 'X', fullName: 'Split End (X Receiver)', depth: 3, x: 5, y: 45 },
            { code: 'OT', name: 'LT', fullName: 'Left Tackle', depth: 3, x: 30, y: 42 },
            { code: 'OG', name: 'LG', fullName: 'Left Guard', depth: 3, x: 40, y: 42 },
            { code: 'C', name: 'C', fullName: 'Center', depth: 3, x: 50, y: 42 },
            { code: 'OG', name: 'RG', fullName: 'Right Guard', depth: 3, x: 60, y: 42, isRight: true },
            { code: 'OT', name: 'RT', fullName: 'Right Tackle', depth: 3, x: 70, y: 42, isRight: true },
            { code: 'WR-SLOT', name: 'Slot', fullName: 'Slot Receiver (Left)', depth: 3, x: 20, y: 45 },
            { code: 'WR-SLOT-R', name: 'Slot', fullName: 'Slot Receiver (Right)', depth: 3, x: 80, y: 45, isRight: true },
            { code: 'WR-Z', name: 'Z', fullName: 'Flanker (Z Receiver)', depth: 3, x: 95, y: 45 },
            { code: 'QB', name: 'QB', fullName: 'Quarterback', depth: 3, x: 50, y: 62 },
            { code: 'RB', name: 'RB', fullName: 'Running Back', depth: 3, x: 50, y: 82 }
          ]
        },
        'pro': {
          name: 'Pro Style (11 Personnel)',
          description: '1 RB, 1 TE, 3 WR',
          positions: [
            { code: 'WR-X', name: 'X', fullName: 'Split End (X Receiver)', depth: 3, x: 5, y: 45 },
            { code: 'OT', name: 'LT', fullName: 'Left Tackle', depth: 3, x: 30, y: 42 },
            { code: 'OG', name: 'LG', fullName: 'Left Guard', depth: 3, x: 40, y: 42 },
            { code: 'C', name: 'C', fullName: 'Center', depth: 3, x: 50, y: 42 },
            { code: 'OG', name: 'RG', fullName: 'Right Guard', depth: 3, x: 60, y: 42, isRight: true },
            { code: 'OT', name: 'RT', fullName: 'Right Tackle', depth: 3, x: 70, y: 42, isRight: true },
            { code: 'TE', name: 'TE', fullName: 'Tight End', depth: 3, x: 78, y: 42 },
            { code: 'WR-SLOT', name: 'Slot', fullName: 'Slot Receiver', depth: 3, x: 85, y: 45 },
            { code: 'WR-Z', name: 'Z', fullName: 'Flanker (Z Receiver)', depth: 3, x: 95, y: 45 },
            { code: 'QB', name: 'QB', fullName: 'Quarterback', depth: 3, x: 50, y: 62 },
            { code: 'RB', name: 'RB', fullName: 'Running Back', depth: 3, x: 50, y: 82 }
          ]
        },
        'i-form': {
          name: 'I-Formation (21 Personnel)',
          description: '2 RB, 1 TE, 2 WR',
          positions: [
            { code: 'WR-X', name: 'X', fullName: 'Split End (X Receiver)', depth: 3, x: 5, y: 45 },
            { code: 'OT', name: 'LT', fullName: 'Left Tackle', depth: 3, x: 30, y: 42 },
            { code: 'OG', name: 'LG', fullName: 'Left Guard', depth: 3, x: 40, y: 42 },
            { code: 'C', name: 'C', fullName: 'Center', depth: 3, x: 50, y: 42 },
            { code: 'OG', name: 'RG', fullName: 'Right Guard', depth: 3, x: 60, y: 42, isRight: true },
            { code: 'OT', name: 'RT', fullName: 'Right Tackle', depth: 3, x: 70, y: 42, isRight: true },
            { code: 'TE', name: 'TE', fullName: 'Tight End', depth: 3, x: 78, y: 42 },
            { code: 'WR-Z', name: 'Z', fullName: 'Flanker (Z Receiver)', depth: 3, x: 95, y: 45 },
            { code: 'QB', name: 'QB', fullName: 'Quarterback', depth: 3, x: 50, y: 58 },
            { code: 'FB', name: 'FB', fullName: 'Fullback', depth: 3, x: 50, y: 72 },
            { code: 'RB', name: 'RB', fullName: 'Running Back', depth: 3, x: 50, y: 86 }
          ]
        },
        'pistol': {
          name: 'Pistol (11 Personnel)',
          description: '1 RB, 1 TE, 3 WR',
          positions: [
            { code: 'WR-X', name: 'X', fullName: 'Split End (X Receiver)', depth: 3, x: 5, y: 45 },
            { code: 'OT', name: 'LT', fullName: 'Left Tackle', depth: 3, x: 30, y: 42 },
            { code: 'OG', name: 'LG', fullName: 'Left Guard', depth: 3, x: 40, y: 42 },
            { code: 'C', name: 'C', fullName: 'Center', depth: 3, x: 50, y: 42 },
            { code: 'OG', name: 'RG', fullName: 'Right Guard', depth: 3, x: 60, y: 42, isRight: true },
            { code: 'OT', name: 'RT', fullName: 'Right Tackle', depth: 3, x: 70, y: 42, isRight: true },
            { code: 'TE', name: 'TE', fullName: 'Tight End', depth: 3, x: 78, y: 42 },
            { code: 'WR-SLOT', name: 'Slot', fullName: 'Slot Receiver', depth: 3, x: 85, y: 45 },
            { code: 'WR-Z', name: 'Z', fullName: 'Flanker (Z Receiver)', depth: 3, x: 95, y: 45 },
            { code: 'QB', name: 'QB', fullName: 'Quarterback', depth: 3, x: 50, y: 58 },
            { code: 'RB', name: 'RB', fullName: 'Running Back', depth: 3, x: 50, y: 75 }
          ]
        },
        '12-personnel': {
          name: '12 Personnel',
          description: '1 RB, 2 TE, 2 WR',
          positions: [
            { code: 'WR-X', name: 'X', fullName: 'Split End (X Receiver)', depth: 3, x: 5, y: 45 },
            { code: 'OT', name: 'LT', fullName: 'Left Tackle', depth: 3, x: 30, y: 42 },
            { code: 'OG', name: 'LG', fullName: 'Left Guard', depth: 3, x: 40, y: 42 },
            { code: 'C', name: 'C', fullName: 'Center', depth: 3, x: 50, y: 42 },
            { code: 'OG', name: 'RG', fullName: 'Right Guard', depth: 3, x: 60, y: 42, isRight: true },
            { code: 'OT', name: 'RT', fullName: 'Right Tackle', depth: 3, x: 70, y: 42, isRight: true },
            { code: 'TE', name: 'TE', fullName: 'Tight End (Y)', depth: 3, x: 78, y: 42 },
            { code: 'TE-2', name: 'TE2', fullName: 'Tight End (F)', depth: 3, x: 22, y: 42 },
            { code: 'WR-Z', name: 'Z', fullName: 'Flanker (Z Receiver)', depth: 3, x: 95, y: 45 },
            { code: 'QB', name: 'QB', fullName: 'Quarterback', depth: 3, x: 50, y: 62 },
            { code: 'RB', name: 'RB', fullName: 'Running Back', depth: 3, x: 50, y: 82 }
          ]
        },
        'empty': {
          name: 'Empty (10 Personnel)',
          description: '0 RB, 1 TE, 4 WR',
          positions: [
            { code: 'WR-X', name: 'X', fullName: 'Split End (X Receiver)', depth: 3, x: 5, y: 45 },
            { code: 'OT', name: 'LT', fullName: 'Left Tackle', depth: 3, x: 30, y: 42 },
            { code: 'OG', name: 'LG', fullName: 'Left Guard', depth: 3, x: 40, y: 42 },
            { code: 'C', name: 'C', fullName: 'Center', depth: 3, x: 50, y: 42 },
            { code: 'OG', name: 'RG', fullName: 'Right Guard', depth: 3, x: 60, y: 42, isRight: true },
            { code: 'OT', name: 'RT', fullName: 'Right Tackle', depth: 3, x: 70, y: 42, isRight: true },
            { code: 'TE', name: 'TE', fullName: 'Tight End', depth: 3, x: 78, y: 42 },
            { code: 'WR-SLOT', name: 'Slot', fullName: 'Slot Receiver (Left)', depth: 3, x: 18, y: 45 },
            { code: 'WR-SLOT-R', name: 'Slot', fullName: 'Slot Receiver (Right)', depth: 3, x: 88, y: 45, isRight: true },
            { code: 'WR-Z', name: 'Z', fullName: 'Flanker (Z Receiver)', depth: 3, x: 95, y: 45 },
            { code: 'QB', name: 'QB', fullName: 'Quarterback', depth: 3, x: 50, y: 62 }
          ]
        },
        'goal-line': {
          name: 'Goal Line / Jumbo',
          description: '2 RB, 2 TE, 1 WR - Power running',
          positions: [
            { code: 'WR-X', name: 'X', fullName: 'Split End (X Receiver)', depth: 3, x: 5, y: 45 },
            { code: 'TE-2', name: 'TE2', fullName: 'Tight End (Left)', depth: 3, x: 22, y: 42 },
            { code: 'OT', name: 'LT', fullName: 'Left Tackle', depth: 3, x: 32, y: 42 },
            { code: 'OG', name: 'LG', fullName: 'Left Guard', depth: 3, x: 42, y: 42 },
            { code: 'C', name: 'C', fullName: 'Center', depth: 3, x: 50, y: 42 },
            { code: 'OG', name: 'RG', fullName: 'Right Guard', depth: 3, x: 58, y: 42, isRight: true },
            { code: 'OT', name: 'RT', fullName: 'Right Tackle', depth: 3, x: 68, y: 42, isRight: true },
            { code: 'TE', name: 'TE', fullName: 'Tight End (Right)', depth: 3, x: 78, y: 42 },
            { code: 'QB', name: 'QB', fullName: 'Quarterback', depth: 3, x: 50, y: 58 },
            { code: 'FB', name: 'FB', fullName: 'Fullback', depth: 3, x: 50, y: 72 },
            { code: 'RB', name: 'RB', fullName: 'Running Back', depth: 3, x: 50, y: 86 }
          ]
        },
        'wildcat': {
          name: 'Wildcat',
          description: 'Direct snap to RB, QB as receiver',
          positions: [
            { code: 'WR-X', name: 'X', fullName: 'Split End (X Receiver)', depth: 3, x: 5, y: 45 },
            { code: 'OT', name: 'LT', fullName: 'Left Tackle', depth: 3, x: 30, y: 42 },
            { code: 'OG', name: 'LG', fullName: 'Left Guard', depth: 3, x: 40, y: 42 },
            { code: 'C', name: 'C', fullName: 'Center', depth: 3, x: 50, y: 42 },
            { code: 'OG', name: 'RG', fullName: 'Right Guard', depth: 3, x: 60, y: 42, isRight: true },
            { code: 'OT', name: 'RT', fullName: 'Right Tackle', depth: 3, x: 70, y: 42, isRight: true },
            { code: 'TE', name: 'TE', fullName: 'Tight End', depth: 3, x: 78, y: 42 },
            { code: 'WR-Z', name: 'Z', fullName: 'Flanker (Z Receiver)', depth: 3, x: 95, y: 45 },
            { code: 'RB', name: 'RB', fullName: 'Running Back (Direct Snap)', depth: 3, x: 50, y: 62 },
            { code: 'RB-2', name: 'RB2', fullName: 'Running Back (Motion)', depth: 3, x: 35, y: 62 },
            { code: 'WR-SLOT', name: 'WR/QB', fullName: 'Receiver/QB Option', depth: 3, x: 20, y: 45 }
          ]
        }
      },
      defense: {
        '4-3': {
          name: '4-3 Defense',
          description: '4 DL, 3 LB, 4 DB',
          positions: [
            { code: 'CB-X', name: 'CB', fullName: 'Cornerback (Left)', depth: 3, x: 5, y: 40 },
            { code: 'DE-1', name: 'DE', fullName: 'Defensive End (Left)', depth: 3, x: 32, y: 40 },
            { code: 'DT-1', name: 'DT', fullName: 'Defensive Tackle (Left)', depth: 3, x: 44, y: 40 },
            { code: 'DT-2', name: 'DT', fullName: 'Defensive Tackle (Right)', depth: 3, x: 56, y: 40 },
            { code: 'DE-2', name: 'DE', fullName: 'Defensive End (Right)', depth: 3, x: 68, y: 40 },
            { code: 'CB-Y', name: 'CB', fullName: 'Cornerback (Right)', depth: 3, x: 95, y: 40 },
            { code: 'LB-WLB', name: 'WLB', fullName: 'Weak Side Linebacker', depth: 3, x: 30, y: 60 },
            { code: 'LB-MLB', name: 'MLB', fullName: 'Middle Linebacker', depth: 3, x: 50, y: 60 },
            { code: 'LB-SLB', name: 'SLB', fullName: 'Strong Side Linebacker', depth: 3, x: 70, y: 60 },
            { code: 'S-FS', name: 'FS', fullName: 'Free Safety', depth: 3, x: 40, y: 80 },
            { code: 'S-SS', name: 'SS', fullName: 'Strong Safety', depth: 3, x: 60, y: 80 }
          ]
        },
        '3-4': {
          name: '3-4 Defense',
          description: '3 DL, 4 LB, 4 DB',
          positions: [
            { code: 'CB-X', name: 'CB', fullName: 'Cornerback (Left)', depth: 3, x: 5, y: 40 },
            { code: 'DE-1', name: 'DE', fullName: 'Defensive End (Left)', depth: 3, x: 35, y: 40 },
            { code: 'NT', name: 'NT', fullName: 'Nose Tackle', depth: 3, x: 50, y: 40 },
            { code: 'DE-2', name: 'DE', fullName: 'Defensive End (Right)', depth: 3, x: 65, y: 40 },
            { code: 'CB-Y', name: 'CB', fullName: 'Cornerback (Right)', depth: 3, x: 95, y: 40 },
            { code: 'LB-LOLB', name: 'LOLB', fullName: 'Left Outside Linebacker', depth: 3, x: 25, y: 55 },
            { code: 'LB-LILB', name: 'LILB', fullName: 'Left Inside Linebacker', depth: 3, x: 42, y: 60 },
            { code: 'LB-RILB', name: 'RILB', fullName: 'Right Inside Linebacker', depth: 3, x: 58, y: 60 },
            { code: 'LB-ROLB', name: 'ROLB', fullName: 'Right Outside Linebacker', depth: 3, x: 75, y: 55 },
            { code: 'S-FS', name: 'FS', fullName: 'Free Safety', depth: 3, x: 40, y: 80 },
            { code: 'S-SS', name: 'SS', fullName: 'Strong Safety', depth: 3, x: 60, y: 80 }
          ]
        },
        'nickel': {
          name: 'Nickel (4-2-5)',
          description: '4 DL, 2 LB, 5 DB',
          positions: [
            { code: 'CB-X', name: 'CB', fullName: 'Cornerback (Left)', depth: 3, x: 5, y: 40 },
            { code: 'DE-1', name: 'DE', fullName: 'Defensive End (Left)', depth: 3, x: 35, y: 40 },
            { code: 'DT-1', name: 'DT', fullName: 'Defensive Tackle (Left)', depth: 3, x: 45, y: 40 },
            { code: 'DT-2', name: 'DT', fullName: 'Defensive Tackle (Right)', depth: 3, x: 55, y: 40 },
            { code: 'DE-2', name: 'DE', fullName: 'Defensive End (Right)', depth: 3, x: 65, y: 40 },
            { code: 'CB-SLOT', name: 'NCB', fullName: 'Nickel Cornerback', depth: 3, x: 75, y: 40 },
            { code: 'CB-Y', name: 'CB', fullName: 'Cornerback (Right)', depth: 3, x: 95, y: 40 },
            { code: 'LB-OLB', name: 'OLB', fullName: 'Outside Linebacker', depth: 3, x: 40, y: 60 },
            { code: 'LB-ILB', name: 'ILB', fullName: 'Inside Linebacker', depth: 3, x: 60, y: 60 },
            { code: 'S-FS', name: 'FS', fullName: 'Free Safety', depth: 3, x: 40, y: 80 },
            { code: 'S-SS', name: 'SS', fullName: 'Strong Safety', depth: 3, x: 60, y: 80 }
          ]
        },
        'dime': {
          name: 'Dime (4-1-6)',
          description: '4 DL, 1 LB, 6 DB',
          positions: [
            { code: 'CB-X', name: 'CB', fullName: 'Cornerback (Left)', depth: 3, x: 5, y: 40 },
            { code: 'DE-1', name: 'DE', fullName: 'Defensive End (Left)', depth: 3, x: 35, y: 40 },
            { code: 'DT-1', name: 'DT', fullName: 'Defensive Tackle (Left)', depth: 3, x: 45, y: 40 },
            { code: 'DT-2', name: 'DT', fullName: 'Defensive Tackle (Right)', depth: 3, x: 55, y: 40 },
            { code: 'DE-2', name: 'DE', fullName: 'Defensive End (Right)', depth: 3, x: 65, y: 40 },
            { code: 'CB-SLOT', name: 'NCB', fullName: 'Nickel Cornerback', depth: 3, x: 75, y: 42 },
            { code: 'CB-SLOT-2', name: 'DCB', fullName: 'Dime Cornerback', depth: 3, x: 25, y: 42 },
            { code: 'CB-Y', name: 'CB', fullName: 'Cornerback (Right)', depth: 3, x: 95, y: 40 },
            { code: 'LB-MLB', name: 'MLB', fullName: 'Middle Linebacker', depth: 3, x: 50, y: 60 },
            { code: 'S-FS', name: 'FS', fullName: 'Free Safety', depth: 3, x: 40, y: 80 },
            { code: 'S-SS', name: 'SS', fullName: 'Strong Safety', depth: 3, x: 60, y: 80 }
          ]
        },
        '3-3-5': {
          name: '3-3-5 Defense',
          description: '3 DL, 3 LB, 5 DB',
          positions: [
            { code: 'CB-X', name: 'CB', fullName: 'Cornerback (Left)', depth: 3, x: 5, y: 40 },
            { code: 'DE-1', name: 'DE', fullName: 'Defensive End (Left)', depth: 3, x: 35, y: 40 },
            { code: 'NT', name: 'NT', fullName: 'Nose Tackle', depth: 3, x: 50, y: 40 },
            { code: 'DE-2', name: 'DE', fullName: 'Defensive End (Right)', depth: 3, x: 65, y: 40 },
            { code: 'CB-SLOT', name: 'NCB', fullName: 'Nickel Cornerback', depth: 3, x: 78, y: 42 },
            { code: 'CB-Y', name: 'CB', fullName: 'Cornerback (Right)', depth: 3, x: 95, y: 40 },
            { code: 'LB-WLB', name: 'WLB', fullName: 'Weak Side Linebacker', depth: 3, x: 30, y: 58 },
            { code: 'LB-MLB', name: 'MLB', fullName: 'Middle Linebacker', depth: 3, x: 50, y: 60 },
            { code: 'LB-SLB', name: 'SLB', fullName: 'Strong Side Linebacker', depth: 3, x: 70, y: 58 },
            { code: 'S-FS', name: 'FS', fullName: 'Free Safety', depth: 3, x: 40, y: 80 },
            { code: 'S-SS', name: 'SS', fullName: 'Strong Safety', depth: 3, x: 60, y: 80 }
          ]
        },
        'bear': {
          name: 'Bear Defense',
          description: '5 DL over center, gap control',
          positions: [
            { code: 'CB-X', name: 'CB', fullName: 'Cornerback (Left)', depth: 3, x: 5, y: 40 },
            { code: 'DE-1', name: 'DE', fullName: 'Defensive End (Left)', depth: 3, x: 28, y: 40 },
            { code: 'DT-1', name: 'DT', fullName: 'Defensive Tackle (Left)', depth: 3, x: 40, y: 40 },
            { code: 'NT', name: 'NT', fullName: 'Nose Tackle', depth: 3, x: 50, y: 40 },
            { code: 'DT-2', name: 'DT', fullName: 'Defensive Tackle (Right)', depth: 3, x: 60, y: 40 },
            { code: 'DE-2', name: 'DE', fullName: 'Defensive End (Right)', depth: 3, x: 72, y: 40 },
            { code: 'CB-Y', name: 'CB', fullName: 'Cornerback (Right)', depth: 3, x: 95, y: 40 },
            { code: 'LB-ILB', name: 'ILB', fullName: 'Inside Linebacker (Left)', depth: 3, x: 35, y: 60 },
            { code: 'LB-ILB-2', name: 'ILB', fullName: 'Inside Linebacker (Right)', depth: 3, x: 65, y: 60 },
            { code: 'S-FS', name: 'FS', fullName: 'Free Safety', depth: 3, x: 40, y: 80 },
            { code: 'S-SS', name: 'SS', fullName: 'Strong Safety', depth: 3, x: 60, y: 80 }
          ]
        },
        '46': {
          name: '46 Defense',
          description: 'Aggressive 8-man box, blitz-heavy',
          positions: [
            { code: 'CB-X', name: 'CB', fullName: 'Cornerback (Left)', depth: 3, x: 5, y: 40 },
            { code: 'DE-1', name: 'DE', fullName: 'Defensive End (Left)', depth: 3, x: 30, y: 40 },
            { code: 'DT-1', name: 'DT', fullName: 'Defensive Tackle (Left)', depth: 3, x: 42, y: 40 },
            { code: 'NT', name: 'NT', fullName: 'Nose Tackle', depth: 3, x: 54, y: 40 },
            { code: 'DE-2', name: 'DE', fullName: 'Defensive End (Right)', depth: 3, x: 68, y: 40 },
            { code: 'CB-Y', name: 'CB', fullName: 'Cornerback (Right)', depth: 3, x: 95, y: 40 },
            { code: 'LB-OLB', name: 'OLB', fullName: 'Outside Linebacker', depth: 3, x: 22, y: 55 },
            { code: 'LB-MLB', name: 'MLB', fullName: 'Middle Linebacker', depth: 3, x: 50, y: 60 },
            { code: 'LB-SLB', name: 'SLB', fullName: 'Strong Linebacker', depth: 3, x: 78, y: 55 },
            { code: 'S-SS', name: 'SS', fullName: 'Strong Safety (In Box)', depth: 3, x: 65, y: 50 },
            { code: 'S-FS', name: 'FS', fullName: 'Free Safety', depth: 3, x: 50, y: 80 }
          ]
        },
        'goal-line-d': {
          name: 'Goal Line Defense',
          description: '6 DL, 3 LB, 2 DB - Stop the run',
          positions: [
            { code: 'CB-X', name: 'CB', fullName: 'Cornerback (Left)', depth: 3, x: 5, y: 45 },
            { code: 'DE-1', name: 'DE', fullName: 'Defensive End (Left)', depth: 3, x: 22, y: 40 },
            { code: 'DT-1', name: 'DT', fullName: 'Defensive Tackle (Left)', depth: 3, x: 34, y: 40 },
            { code: 'NT', name: 'NT', fullName: 'Nose Tackle', depth: 3, x: 46, y: 40 },
            { code: 'DT-2', name: 'DT', fullName: 'Defensive Tackle (Right)', depth: 3, x: 58, y: 40 },
            { code: 'DE-2', name: 'DE', fullName: 'Defensive End (Right)', depth: 3, x: 70, y: 40 },
            { code: 'CB-Y', name: 'CB', fullName: 'Cornerback (Right)', depth: 3, x: 95, y: 45 },
            { code: 'LB-OLB', name: 'OLB', fullName: 'Outside Linebacker', depth: 3, x: 28, y: 58 },
            { code: 'LB-MLB', name: 'MLB', fullName: 'Middle Linebacker', depth: 3, x: 50, y: 60 },
            { code: 'LB-SLB', name: 'SLB', fullName: 'Strong Linebacker', depth: 3, x: 72, y: 58 },
            { code: 'S-SS', name: 'SS', fullName: 'Strong Safety', depth: 3, x: 50, y: 78 }
          ]
        }
      }
    };

    const POSITIONS = {
      offense: [
        { code: 'WR-X', name: 'X', fullName: 'Split End (X Receiver)', depth: 3, x: 5, y: 45 },
        { code: 'OT', name: 'LT', fullName: 'Left Tackle', depth: 3, x: 30, y: 42 },
        { code: 'OG', name: 'LG', fullName: 'Left Guard', depth: 3, x: 40, y: 42 },
        { code: 'C', name: 'C', fullName: 'Center', depth: 3, x: 50, y: 42 },
        { code: 'OG', name: 'RG', fullName: 'Right Guard', depth: 3, x: 60, y: 42, isRight: true },
        { code: 'OT', name: 'RT', fullName: 'Right Tackle', depth: 3, x: 70, y: 42, isRight: true },
        { code: 'TE', name: 'TE', fullName: 'Tight End', depth: 3, x: 78, y: 42 },
        { code: 'WR-SLOT', name: 'Slot', fullName: 'Slot Receiver', depth: 3, x: 85, y: 45 },
        { code: 'WR-Z', name: 'Z', fullName: 'Flanker (Z Receiver)', depth: 3, x: 95, y: 45 },
        { code: 'QB', name: 'QB', fullName: 'Quarterback', depth: 3, x: 50, y: 62 },
        { code: 'RB', name: 'RB', fullName: 'Running Back', depth: 3, x: 50, y: 82 }
      ],
      defense: [
        { code: 'CB-X', name: 'CB', fullName: 'Cornerback (X Side)', depth: 3, x: 5, y: 40 },
        { code: 'DE-1', name: 'DE', fullName: 'Defensive End (Left)', depth: 3, x: 35, y: 40 },
        { code: 'DT-1', name: 'DT', fullName: 'Defensive Tackle (Left)', depth: 3, x: 45, y: 40 },
        { code: 'DT-2', name: 'DT', fullName: 'Defensive Tackle (Right)', depth: 3, x: 55, y: 40 },
        { code: 'DE-2', name: 'DE', fullName: 'Defensive End (Right)', depth: 3, x: 65, y: 40 },
        { code: 'CB-SLOT', name: 'NCB', fullName: 'Nickel Cornerback (Slot)', depth: 3, x: 75, y: 40 },
        { code: 'CB-Y', name: 'CB', fullName: 'Cornerback (Y Side)', depth: 3, x: 95, y: 40 },
        { code: 'LB-OLB', name: 'OLB', fullName: 'Outside Linebacker', depth: 3, x: 40, y: 60 },
        { code: 'LB-ILB', name: 'ILB', fullName: 'Inside Linebacker', depth: 3, x: 60, y: 60 },
        { code: 'S-FS', name: 'FS', fullName: 'Free Safety', depth: 3, x: 40, y: 80 },
        { code: 'S-SS', name: 'SS', fullName: 'Strong Safety', depth: 3, x: 60, y: 80 }
      ],
      special: [
        { code: 'K', name: 'K', fullName: 'Placekicker', depth: 3, x: 25, y: 30 },
        { code: 'KOS', name: 'KOS', fullName: 'Kickoff Specialist', depth: 3, x: 75, y: 30 },
        { code: 'P', name: 'P', fullName: 'Punter', depth: 3, x: 25, y: 55 },
        { code: 'H', name: 'H', fullName: 'Holder', depth: 3, x: 75, y: 55 },
        { code: 'LS', name: 'LS', fullName: 'Long Snapper', depth: 3, x: 25, y: 80 },
        { code: 'KR', name: 'KR', fullName: 'Kick Returner', depth: 3, x: 75, y: 80 },
        { code: 'PR', name: 'PR', fullName: 'Punt Returner', depth: 3, x: 50, y: 55 }
      ]
    };

    // Default empty roster - will be populated by scraper
    const DEFAULT_ROSTER = [];

    // Default team config
    const DEFAULT_TEAM = {
      name: 'Your Team',
      primaryColor: '#1a1a2e',
      secondaryColor: '#ffffff',
      rosterUrl: ''
    };

    class DepthChartApp {
      constructor() {
        this.depthChart = {};
        this.roster = DEFAULT_ROSTER;
        this.team = DEFAULT_TEAM;
        this.activeTab = 'offense';
        this.depthLevel = 0;
        this.selectedSlot = null;
        this.showPlayerModal = false;
        this.showImportModal = false;
        this.showResetModal = false;
        this.showSetupModal = false;
        this.showTeamSettingsModal = false;
        this.showAppResetModal = false;
        this.fetchingRoster = false;
        this.importText = '';
        this.importMessage = '';
        this.searchQuery = '';
        this.saving = false;
        this.loading = true;
        this.darkMode = false;
        this.showOnboarding = false;
        this.draggedPlayer = null;
        this.dragOverPosition = null;

        // Quick depth reorder
        this.showDepthReorderModal = false;
        this.selectedPositionGroup = null;

        // Two-deep view mode (show starter + backup together)
        this.twoDeepView = false;

        // Player status tracking (injuries, suspensions, portal)
        this.playerStatuses = {}; // { 'playerKey': 'OUT' | 'DOUBTFUL' | 'QUESTIONABLE' | 'PROBABLE' | 'SUSPENDED' | 'PORTAL' }

        // Player notes
        this.playerNotes = {}; // { 'playerKey': 'note text' }

        // Position battles ("OR" - undecided starter)
        this.positionBattles = {}; // { 'positionKey': true }

        // Status edit modal
        this.showStatusModal = false;
        this.statusEditPlayer = null;

        // Setup import tab state
        this.setupImportTab = 'url';

        // Touch/swipe tracking for mobile tab switching
        this.touchStartX = 0;
        this.touchStartY = 0;
        this.touchEndX = 0;
        this.touchEndY = 0;

        // Formation state
        this.offenseFormation = 'pro';
        this.defenseFormation = 'nickel';

        this.undoStack = [];
        this.redoStack = [];
        this.maxUndoSteps = 20;
        this.lastSaved = null;

        // Shareable URL / read-only viewer
        this.readOnlyMode = false;
        this.toastMessage = '';
        this.toastTimeout = null;

        this.init();
      }

      init() {
        this.render();

        setTimeout(() => {
          // Check for shared depth chart in URL hash
          if (this.loadFromShareUrl()) {
            this.loading = false;
            this.applyTeamColors();
            this.render();
            return;
          }

          this.loadDarkMode();
          this.loadFormations();
          this.loadTeam();
          this.loadDepthChart();
          this.loadRoster();
          this.checkOnboarding();
          this.loading = false;
          this.applyTeamColors();
          this.render();
          this.setupKeyboardShortcuts();
        }, 500);
      }

      loadTeam() {
        const saved = localStorage.getItem('generic-team-config');
        if (saved) {
          try {
            const savedTeam = JSON.parse(saved);
            // Check if the team has changed (new scrape)
            if (savedTeam.name !== DEFAULT_TEAM.name || savedTeam.rosterUrl !== DEFAULT_TEAM.rosterUrl) {
              // Team changed - clear old data and use new defaults
              console.log(`Team changed from ${savedTeam.name} to ${DEFAULT_TEAM.name}, resetting data...`);
              localStorage.removeItem('generic-team-config');
              localStorage.removeItem('generic-roster');
              localStorage.removeItem('generic-depth-chart');
              this.team = { ...DEFAULT_TEAM };
              this.roster = [...DEFAULT_ROSTER];
              this.initializeEmptyChart();
              return;
            }
            this.team = { ...DEFAULT_TEAM, ...savedTeam };
          } catch (e) {
            console.error('Failed to parse saved team config, using defaults:', e);
            localStorage.removeItem('generic-team-config');
          }
        }
      }

      saveTeam() {
        localStorage.setItem('generic-team-config', JSON.stringify(this.team));
        this.applyTeamColors();
      }

      applyTeamColors() {
        document.documentElement.style.setProperty('--primary-color', this.team.primaryColor);
        document.body.style.background = `linear-gradient(135deg, ${this.team.primaryColor} 0%, ${this.adjustColor(this.team.primaryColor, 30)} 50%, ${this.team.primaryColor} 100%)`;
      }

      adjustColor(color, amount) {
        // Parse color to RGB components
        let r, g, b;
        const rgbMatch = color.match(/^rgb\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*\)$/i);
        if (rgbMatch) {
          r = parseInt(rgbMatch[1]);
          g = parseInt(rgbMatch[2]);
          b = parseInt(rgbMatch[3]);
        } else {
          const hex = color.replace('#', '');
          r = parseInt(hex.substr(0, 2), 16);
          g = parseInt(hex.substr(2, 2), 16);
          b = parseInt(hex.substr(4, 2), 16);
        }
        // Fallback if parsing failed
        if (isNaN(r) || isNaN(g) || isNaN(b)) return color;
        r = Math.min(255, r + amount);
        g = Math.min(255, g + amount);
        b = Math.min(255, b + amount);
        return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
      }

      loadDarkMode() {
        const saved = localStorage.getItem('generic-dark-mode');
        if (saved !== null) {
          try {
            this.darkMode = JSON.parse(saved);
          } catch {
            this.darkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
          }
        } else {
          this.darkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
        }
        this.applyDarkMode();
      }

      applyDarkMode() {
        if (this.darkMode) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
      }

      toggleDarkMode() {
        this.darkMode = !this.darkMode;
        localStorage.setItem('generic-dark-mode', JSON.stringify(this.darkMode));
        this.applyDarkMode();
        this.render();
      }

      loadDepthChart() {
        try {
          const saved = localStorage.getItem('generic-depth-chart');
          if (saved) {
            this.depthChart = JSON.parse(saved);
          } else {
            this.initializeEmptyChart();
          }
        } catch (e) {
          console.error('Failed to parse depth chart, resetting:', e);
          localStorage.removeItem('generic-depth-chart');
          this.initializeEmptyChart();
        }
        // Load player statuses
        try {
          const savedStatuses = localStorage.getItem('generic-player-statuses');
          if (savedStatuses) this.playerStatuses = JSON.parse(savedStatuses);
        } catch { localStorage.removeItem('generic-player-statuses'); }
        // Load player notes
        try {
          const savedNotes = localStorage.getItem('generic-player-notes');
          if (savedNotes) this.playerNotes = JSON.parse(savedNotes);
        } catch { localStorage.removeItem('generic-player-notes'); }
        // Load position battles
        try {
          const savedBattles = localStorage.getItem('generic-position-battles');
          if (savedBattles) this.positionBattles = JSON.parse(savedBattles);
        } catch { localStorage.removeItem('generic-position-battles'); }
        // Load two-deep view preference
        try {
          const savedTwoDeep = localStorage.getItem('generic-two-deep-view');
          if (savedTwoDeep !== null) this.twoDeepView = JSON.parse(savedTwoDeep);
        } catch { localStorage.removeItem('generic-two-deep-view'); }
      }

      loadRoster() {
        try {
          const saved = localStorage.getItem('generic-roster');
          if (saved) {
            this.roster = JSON.parse(saved);
          }
        } catch (e) {
          console.error('Failed to parse roster, resetting:', e);
          localStorage.removeItem('generic-roster');
          this.roster = [];
        }
      }

      checkOnboarding() {
        const hasSeenOnboarding = localStorage.getItem('generic-onboarding-seen');
        const hasRoster = this.roster.length > 0;
        this.showOnboarding = !hasSeenOnboarding && !hasRoster;
        this.showSetupModal = !hasRoster && !this.showOnboarding;
      }

      dismissOnboarding() {
        this.showOnboarding = false;
        localStorage.setItem('generic-onboarding-seen', 'true');
        if (this.roster.length === 0) {
          this.showSetupModal = true;
        }
        this.render();
      }

      initializeEmptyChart() {
        Object.values(POSITIONS).flat().forEach(pos => {
          const key = pos.isRight ? `${pos.code}-R` : pos.code;
          this.depthChart[key] = Array(pos.depth).fill(null);
        });
      }

      saveStateForUndo() {
        this.undoStack.push(JSON.stringify(this.depthChart));
        if (this.undoStack.length > this.maxUndoSteps) {
          this.undoStack.shift();
        }
        this.redoStack = [];
      }

      undo() {
        if (this.undoStack.length > 0) {
          this.redoStack.push(JSON.stringify(this.depthChart));
          this.depthChart = JSON.parse(this.undoStack.pop());
          this.autoSave();
          this.render();
        }
      }

      redo() {
        if (this.redoStack.length > 0) {
          this.undoStack.push(JSON.stringify(this.depthChart));
          this.depthChart = JSON.parse(this.redoStack.pop());
          this.autoSave();
          this.render();
        }
      }

      autoSave() {
        localStorage.setItem('generic-depth-chart', JSON.stringify(this.depthChart));
        localStorage.setItem('generic-player-statuses', JSON.stringify(this.playerStatuses));
        localStorage.setItem('generic-player-notes', JSON.stringify(this.playerNotes));
        localStorage.setItem('generic-position-battles', JSON.stringify(this.positionBattles));
        localStorage.setItem('generic-two-deep-view', JSON.stringify(this.twoDeepView));
        this.lastSaved = new Date();
        this.saving = true;
        this.render();
        setTimeout(() => {
          this.saving = false;
          this.render();
        }, 1500);
      }

      exportDepthChart() {
        let text = `${this.team.name.toUpperCase()} FOOTBALL DEPTH CHART\n${'='.repeat(this.team.name.length + 21)}\n`;
        text += `Generated: ${new Date().toLocaleDateString()}\n\n`;

        const sections = {
          'OFFENSE': ['QB', 'RB', 'FB', 'WR-X', 'WR-Z', 'WR-SLOT', 'WR-SLOT-R', 'TE', 'TE-2', 'OT', 'OT-R', 'OG', 'OG-R', 'C'],
          'DEFENSE': ['DE-1', 'DE-2', 'DT-1', 'DT-2', 'NT', 'LB-ILB', 'LB-OLB', 'LB-MLB', 'CB-X', 'CB-Y', 'CB-SLOT', 'S-FS', 'S-SS'],
          'SPECIAL TEAMS': ['K', 'KOS', 'P', 'H', 'LS', 'KR', 'PR']
        };

        for (const [section, positions] of Object.entries(sections)) {
          text += `${section}\n${'-'.repeat(section.length)}\n\n`;

          for (const pos of positions) {
            const players = this.depthChart[pos] || [];
            const filled = players.filter(p => p !== null);

            if (filled.length > 0) {
              const posLabel = this.getSlotDisplayName(pos);
              const isBattle = this.positionBattles[pos];
              text += `${posLabel}${isBattle ? ' (OR)' : ''}:\n`;
              filled.forEach((p, i) => {
                const status = this.getPlayerStatus(p);
                const note = this.getPlayerNote(p);
                let line = `  ${i + 1}. #${p.number} ${p.name} (${p.year})`;
                if (status) line += ` [${status}]`;
                if (note) line += ` - ${note}`;
                text += line + '\n';
              });
              text += '\n';
            }
          }
          text += '\n';
        }

        const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${this.team.name.toLowerCase().replace(/\s+/g, '-')}-depth-chart-${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      exportFullBackup() {
        const backupKeys = [
          'generic-depth-chart', 'generic-player-statuses', 'generic-player-notes',
          'generic-position-battles', 'generic-two-deep-view', 'generic-team-config',
          'generic-roster', 'generic-dark-mode', 'depth-chart-offense-formation',
          'depth-chart-defense-formation'
        ];
        const backup = { version: 1, exportDate: new Date().toISOString() };
        backupKeys.forEach(key => {
          const val = localStorage.getItem(key);
          if (val !== null) backup[key] = val;
        });
        const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `depth-chart-backup-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      importFullBackup() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = (e) => {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (ev) => {
            try {
              const data = JSON.parse(ev.target.result);
              if (!data.version || !data['generic-depth-chart']) {
                alert('Invalid backup file. The file must be a depth chart backup exported from this app.');
                return;
              }
              if (!confirm('This will replace all current data. Continue?')) return;
              const backupKeys = [
                'generic-depth-chart', 'generic-player-statuses', 'generic-player-notes',
                'generic-position-battles', 'generic-two-deep-view', 'generic-team-config',
                'generic-roster', 'generic-dark-mode', 'depth-chart-offense-formation',
                'depth-chart-defense-formation'
              ];
              backupKeys.forEach(key => {
                if (data[key] !== undefined) {
                  localStorage.setItem(key, data[key]);
                }
              });
              window.location.reload();
            } catch (err) {
              alert('Failed to read backup file. Make sure it is a valid JSON file.');
            }
          };
          reader.readAsText(file);
        };
        input.click();
      }

      // Shareable URL methods
      // Compact share format: single-char keys, player arrays [number, name, year],
      // strip nulls/empties. Cuts payload ~60% before compression.
      buildSharePayload() {
        // Compact depth chart: only include non-null players, as [number, name, year] arrays
        const dc = {};
        for (const [posKey, players] of Object.entries(this.depthChart)) {
          if (!players) continue;
          const compact = [];
          let hasPlayer = false;
          for (let i = 0; i < players.length; i++) {
            const p = players[i];
            if (p) {
              compact[i] = [p.number, p.name, p.year || ''];
              hasPlayer = true;
            }
          }
          if (hasPlayer) dc[posKey] = compact;
        }

        // Only include non-empty statuses
        const st = {};
        for (const [k, v] of Object.entries(this.playerStatuses)) {
          if (v) st[k] = v;
        }

        const payload = {
          t: [this.team.name, this.team.primaryColor, this.team.secondaryColor || '#ffffff'],
          d: dc,
          o: this.offenseFormation,
          f: this.defenseFormation
        };
        // Only include optional fields if non-default
        if (Object.keys(st).length > 0) payload.s = st;
        if (this.twoDeepView) payload.v = 1;

        return payload;
      }

      shareViaUrl() {
        try {
          const payload = JSON.stringify(this.buildSharePayload());
          const compressed = LZString.compressToEncodedURIComponent(payload);
          const shareUrl = window.location.origin + window.location.pathname + '#s=' + compressed;
          navigator.clipboard.writeText(shareUrl).then(() => {
            this.showToast('Share link copied to clipboard!');
          }).catch(() => {
            const ta = document.createElement('textarea');
            ta.value = shareUrl;
            ta.style.position = 'fixed';
            ta.style.opacity = '0';
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
            this.showToast('Share link copied to clipboard!');
          });
        } catch (err) {
          console.error('Failed to create share URL:', err);
          this.showToast('Failed to create share link. The depth chart may be too large.');
        }
      }

      loadFromShareUrl() {
        const hash = window.location.hash;
        // Support both #s= (compact) and legacy #share= format
        let compressed;
        if (hash.startsWith('#s=')) {
          compressed = hash.substring(3);
        } else if (hash.startsWith('#share=')) {
          compressed = hash.substring(7);
        } else {
          return false;
        }

        try {
          const json = LZString.decompressFromEncodedURIComponent(compressed);
          if (!json) return false;
          const data = JSON.parse(json);

          this.readOnlyMode = true;

          // Detect compact format (has 't' array) vs legacy format (has 'team' object)
          if (data.t && Array.isArray(data.t)) {
            // Compact format
            this.team = { ...this.team, name: data.t[0], primaryColor: data.t[1], secondaryColor: data.t[2] || '#ffffff' };

            // Expand compact player arrays back to full objects
            const dc = {};
            for (const [posKey, slots] of Object.entries(data.d || {})) {
              dc[posKey] = [];
              for (let i = 0; i < slots.length; i++) {
                if (slots[i]) {
                  dc[posKey][i] = { number: slots[i][0], name: slots[i][1], year: slots[i][2] || '', position: '', height: '', weight: '', hometown: '', highSchool: '', previousSchool: '', url: '' };
                } else {
                  dc[posKey][i] = null;
                }
              }
            }
            this.depthChart = dc;
            this.playerStatuses = data.s || {};
            this.offenseFormation = data.o || 'pro';
            this.defenseFormation = data.f || 'nickel';
            this.twoDeepView = !!data.v;
          } else {
            // Legacy format
            this.team = { ...this.team, ...data.team };
            this.depthChart = data.depthChart || {};
            this.playerStatuses = data.playerStatuses || {};
            this.offenseFormation = data.offenseFormation || 'pro';
            this.defenseFormation = data.defenseFormation || 'nickel';
            this.twoDeepView = data.twoDeepView || false;
          }

          this.loadDarkMode();
          return true;
        } catch (err) {
          console.error('Failed to load shared depth chart:', err);
          return false;
        }
      }

      loadSharedIntoEditor() {
        // Save current shared state to localStorage
        localStorage.setItem('generic-team-config', JSON.stringify(this.team));
        localStorage.setItem('generic-depth-chart', JSON.stringify(this.depthChart));
        localStorage.setItem('generic-player-statuses', JSON.stringify(this.playerStatuses));
        localStorage.setItem('depth-chart-offense-formation', this.offenseFormation);
        localStorage.setItem('depth-chart-defense-formation', this.defenseFormation);
        localStorage.setItem('generic-two-deep-view', JSON.stringify(this.twoDeepView));

        // Clear hash and reload
        window.location.hash = '';
        window.location.reload();
      }

      dismissShareBanner() {
        this._shareBannerDismissed = true;
        this.render();
      }

      showToast(message) {
        this.toastMessage = message;
        if (this.toastTimeout) clearTimeout(this.toastTimeout);
        this.render();
        this.toastTimeout = setTimeout(() => {
          this.toastMessage = '';
          this.render();
        }, 3000);
      }

      // Player status helper methods
      getPlayerKey(player) {
        return `${player.number}-${player.name}`;
      }

      getPlayerStatus(player) {
        if (!player) return null;
        return this.playerStatuses[this.getPlayerKey(player)] || null;
      }

      setPlayerStatus(player, status) {
        if (!player) return;
        const key = this.getPlayerKey(player);
        if (status) {
          this.playerStatuses[key] = status;
        } else {
          delete this.playerStatuses[key];
        }
        this.autoSave();
      }

      getStatusColor(status) {
        const colors = {
          'OUT': 'bg-red-500',
          'DOUBTFUL': 'bg-red-400',
          'QUESTIONABLE': 'bg-yellow-500',
          'PROBABLE': 'bg-green-400',
          'SUSPENDED': 'bg-purple-500',
          'PORTAL': 'bg-blue-500',
          'REDSHIRT': 'bg-gray-500'
        };
        return colors[status] || 'bg-gray-400';
      }

      getStatusBadge(status) {
        const badges = {
          'OUT': 'OUT',
          'DOUBTFUL': 'DBT',
          'QUESTIONABLE': 'Q',
          'PROBABLE': 'PROB',
          'SUSPENDED': 'SUS',
          'PORTAL': 'PTL',
          'REDSHIRT': 'RS'
        };
        return badges[status] || status;
      }

      // Player notes helper methods
      getPlayerNote(player) {
        if (!player) return '';
        return this.playerNotes[this.getPlayerKey(player)] || '';
      }

      setPlayerNote(player, note) {
        if (!player) return;
        const key = this.getPlayerKey(player);
        if (note && note.trim()) {
          this.playerNotes[key] = note.trim();
        } else {
          delete this.playerNotes[key];
        }
        this.autoSave();
      }

      // Position battle toggle
      togglePositionBattle(posKey) {
        if (this.positionBattles[posKey]) {
          delete this.positionBattles[posKey];
        } else {
          this.positionBattles[posKey] = true;
        }
        this.autoSave();
        this.render();
      }

      // Two-deep view toggle
      toggleTwoDeepView() {
        this.twoDeepView = !this.twoDeepView;
        this.autoSave();
        this.render();
      }

      // Share as image
      async shareAsImage() {
        // Create a canvas from the field view
        const fieldEl = document.querySelector('.field-container');
        if (!fieldEl) return;

        try {
          // Use html2canvas if available, or create a styled version
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');

          // Set canvas size
          canvas.width = 1200;
          canvas.height = 800;

          // Draw background
          const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
          gradient.addColorStop(0, '#15803d');
          gradient.addColorStop(1, '#166534');
          ctx.fillStyle = gradient;
          ctx.fillRect(0, 0, canvas.width, canvas.height);

          // Draw field lines
          ctx.strokeStyle = 'rgba(255,255,255,0.15)';
          ctx.lineWidth = 2;
          for (let i = 1; i < 10; i++) {
            const y = (canvas.height / 10) * i;
            ctx.beginPath();
            ctx.moveTo(0, y);
            ctx.lineTo(canvas.width, y);
            ctx.stroke();
          }

          // Draw header
          ctx.fillStyle = this.team.primaryColor;
          ctx.fillRect(0, 0, canvas.width, 80);
          ctx.fillStyle = 'white';
          ctx.font = 'bold 36px Bebas Neue, sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText(`${this.team.name.toUpperCase()} DEPTH CHART`, canvas.width / 2, 52);
          ctx.font = '18px sans-serif';
          ctx.fillText(`${this.activeTab.toUpperCase()} - ${this.twoDeepView ? 'Two-Deep' : ['Starters', '2nd String', '3rd String'][this.depthLevel]}`, canvas.width / 2, 75);

          // Draw positions
          const positions = this.getPositions(this.activeTab);
          ctx.font = 'bold 14px sans-serif';

          positions.forEach(pos => {
            const posKey = pos.isRight ? `${pos.code}-R` : pos.code;
            const x = (pos.x / 100) * canvas.width;
            const y = 80 + ((pos.y / 100) * (canvas.height - 100));

            // Position box
            const player = this.depthChart[posKey]?.[this.depthLevel];
            const boxWidth = 90;
            const boxHeight = this.twoDeepView ? 70 : 50;

            ctx.fillStyle = player ? this.team.primaryColor : 'white';
            ctx.strokeStyle = this.team.primaryColor;
            ctx.lineWidth = 2;
            ctx.beginPath();
            if (ctx.roundRect) {
              ctx.roundRect(x - boxWidth/2, y - boxHeight/2, boxWidth, boxHeight, 8);
            } else {
              // Fallback for browsers without roundRect
              const rx = x - boxWidth/2, ry = y - boxHeight/2, w = boxWidth, h = boxHeight, rad = 8;
              ctx.moveTo(rx + rad, ry);
              ctx.arcTo(rx + w, ry, rx + w, ry + h, rad);
              ctx.arcTo(rx + w, ry + h, rx, ry + h, rad);
              ctx.arcTo(rx, ry + h, rx, ry, rad);
              ctx.arcTo(rx, ry, rx + w, ry, rad);
              ctx.closePath();
            }
            ctx.fill();
            ctx.stroke();

            // Position name
            ctx.fillStyle = player ? 'white' : this.team.primaryColor;
            ctx.textAlign = 'center';
            ctx.font = 'bold 12px sans-serif';
            ctx.fillText(pos.name, x, y - (this.twoDeepView ? 22 : 12));

            // Player name
            if (player) {
              ctx.font = 'bold 14px sans-serif';
              ctx.fillText(`#${player.number}`, x, y + (this.twoDeepView ? -5 : 5));
              ctx.font = '11px sans-serif';
              ctx.fillText(this.getPlayerLastName(player.name), x, y + (this.twoDeepView ? 10 : 18));

              // Status badge
              const status = this.getPlayerStatus(player);
              if (status) {
                ctx.fillStyle = this.getStatusColor(status).replace('bg-', '').includes('red') ? '#ef4444' :
                               this.getStatusColor(status).includes('yellow') ? '#eab308' :
                               this.getStatusColor(status).includes('green') ? '#22c55e' : '#8b5cf6';
                ctx.beginPath();
                ctx.arc(x + boxWidth/2 - 8, y - boxHeight/2 + 8, 6, 0, Math.PI * 2);
                ctx.fill();
              }

              // Two-deep: show backup
              if (this.twoDeepView) {
                const backup = this.depthChart[posKey]?.[1];
                if (backup) {
                  ctx.fillStyle = 'rgba(255,255,255,0.7)';
                  ctx.font = '10px sans-serif';
                  ctx.fillText(`#${backup.number} ${this.getPlayerLastName(backup.name)}`, x, y + 25);
                }
              }
            }

            // Position battle indicator
            if (this.positionBattles[posKey]) {
              ctx.fillStyle = '#fbbf24';
              ctx.font = 'bold 10px sans-serif';
              ctx.fillText('OR', x, y + boxHeight/2 + 12);
            }
          });

          // Add watermark
          ctx.fillStyle = 'rgba(255,255,255,0.5)';
          ctx.font = '12px sans-serif';
          ctx.textAlign = 'right';
          ctx.fillText('Created with CFB Depth Chart Builder', canvas.width - 20, canvas.height - 15);

          // Convert to blob and download
          canvas.toBlob((blob) => {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${this.team.name.toLowerCase().replace(/\s+/g, '-')}-depth-chart-${this.activeTab}.png`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          }, 'image/png');

        } catch (error) {
          console.error('Error generating image:', error);
          alert('Could not generate image. Try using the Print function instead.');
        }
      }

      // Open status/notes modal for a player
      openStatusModal(player, posKey, depth) {
        this.statusEditPlayer = { player, posKey, depth };
        this.showStatusModal = true;
        this.render();
      }

      showResetConfirmation() {
        this.showResetModal = true;
        this.render();
      }

      confirmReset() {
        this.saveStateForUndo();
        this.initializeEmptyChart();
        this.autoSave();
        this.showResetModal = false;
        this.render();
      }

      resetApp() {
        this.showTeamSettingsModal = false;
        this.showAppResetModal = true;
        this.render();
      }

      confirmAppReset() {
        // Clear all localStorage data for this app
        localStorage.removeItem('generic-team-config');
        localStorage.removeItem('generic-roster');
        localStorage.removeItem('generic-depth-chart');
        localStorage.removeItem('generic-onboarding-seen');
        localStorage.removeItem('generic-dark-mode');
        localStorage.removeItem('generic-player-statuses');
        localStorage.removeItem('generic-player-notes');
        localStorage.removeItem('generic-position-battles');
        localStorage.removeItem('generic-two-deep-view');

        // Reset app state directly
        this.roster = [];
        this.team = { name: 'Your Team', primaryColor: '#1a1a2e', secondaryColor: '#ffffff', rosterUrl: '' };
        this.depthChart = {};
        this.initializeEmptyChart();
        this.showAppResetModal = false;
        this.showSetupModal = true;
        this.showOnboarding = false;
        this.applyTeamColors();
        this.render();
      }

      importRoster() {
        try {
          const lines = this.importText.split('\n').filter(line => line.trim());
          const newRoster = [];

          for (const line of lines) {
            const commaFormat = line.match(/(\d+),?\s*([^,]+),?\s*([A-Z]{1,3}),?\s*(.+)/);
            const hashFormat = line.match(/#(\d+)\s+([A-Za-z\s'.]+?)\s+([A-Z]{1,3})\s+(.+)/);

            let match = commaFormat || hashFormat;

            if (match) {
              const number = parseInt(match[1]);
              const name = match[2].trim();
              const position = match[3].trim();
              const year = match[4].trim();

              const validPositions = ['QB', 'RB', 'FB', 'WR', 'TE', 'OL', 'OT', 'OG', 'C', 'DL', 'DE', 'DT', 'NT', 'EDGE', 'LB', 'ILB', 'OLB', 'MLB', 'DB', 'CB', 'S', 'SS', 'FS', 'K', 'PK', 'P', 'LS', 'SNP'];
              if (validPositions.includes(position) && !isNaN(number)) {
                newRoster.push({ name, number, position, year, height: '', weight: '', hometown: '', highSchool: '', previousSchool: '', url: '' });
              }
            }
          }

          if (newRoster.length > 0) {
            this.roster = newRoster;
            localStorage.setItem('generic-roster', JSON.stringify(newRoster));
            this.importMessage = `Successfully imported ${newRoster.length} players!`;
            setTimeout(() => {
              this.showImportModal = false;
              this.showSetupModal = false;
              this.importText = '';
              this.importMessage = '';
              this.render();
            }, 2000);
          } else {
            this.importMessage = 'No valid players found. Please check the format.';
          }
          this.render();
        } catch (error) {
          this.importMessage = 'Error parsing roster data. Please check the format.';
          this.render();
        }
      }

      getAvailablePlayers(posCode) {
        let positionToSearch = posCode.replace('-R', '');
        if (positionToSearch.startsWith('WR-')) positionToSearch = 'WR';
        else if (positionToSearch.startsWith('TE-')) positionToSearch = 'TE';
        else if (positionToSearch.startsWith('RB-')) positionToSearch = 'RB';
        else if (['OT', 'OG', 'C'].includes(positionToSearch)) positionToSearch = 'OL';
        else if (positionToSearch.startsWith('CB-')) positionToSearch = 'CB';
        else if (positionToSearch.startsWith('S-')) positionToSearch = 'S';
        else if (positionToSearch.startsWith('LB-')) positionToSearch = 'LB';
        else if (positionToSearch.startsWith('DE-')) positionToSearch = 'DE';
        else if (positionToSearch.startsWith('DT-')) positionToSearch = 'DT';
        else if (positionToSearch.startsWith('NT-') || positionToSearch === 'NT') positionToSearch = 'NT';

        // Allow DL, DE, DT, NT players to appear in any defensive line position
        const positionsToMatch = [positionToSearch];
        if (positionToSearch === 'DE' || positionToSearch === 'DT' || positionToSearch === 'NT') {
          positionsToMatch.push('DL', 'DE', 'DT', 'NT', 'EDGE');
        }
        // Allow DB, CB, and S players in CB and S positions
        if (positionToSearch === 'CB' || positionToSearch === 'S') {
          positionsToMatch.push('DB', 'CB', 'S');
        }
        // Kick/Punt returners can be WR, RB, or DB
        if (positionToSearch === 'KR' || positionToSearch === 'PR') {
          positionsToMatch.push('WR', 'RB', 'FB', 'DB', 'CB', 'S');
        }
        // Holder can be QB or P
        if (positionToSearch === 'H') {
          positionsToMatch.push('QB', 'P');
        }
        // Kickoff specialist can be K or P
        if (positionToSearch === 'KOS') {
          positionsToMatch.push('K', 'PK', 'P');
        }

        let allPlayers = this.roster.filter(p => positionsToMatch.includes(p.position));

        // Get all players assigned to ANY position with their assignments
        const assignedMap = new Map();
        Object.entries(this.depthChart).forEach(([pos, depthArray]) => {
          depthArray.forEach((player, depth) => {
            if (player) {
              const key = `${player.number}-${player.name}`;
              if (!assignedMap.has(key)) {
                assignedMap.set(key, []);
              }
              assignedMap.get(key).push({ position: pos, depth });
            }
          });
        });

        // Mark players as assigned and add their current assignments
        allPlayers = allPlayers.map(p => {
          const key = `${p.number}-${p.name}`;
          const assignments = assignedMap.get(key) || [];
          return {
            ...p,
            isAssigned: assignments.length > 0,
            assignments: assignments
          };
        });

        // Sort: unassigned first, then assigned
        allPlayers.sort((a, b) => {
          if (a.isAssigned && !b.isAssigned) return 1;
          if (!a.isAssigned && b.isAssigned) return -1;
          return 0;
        });

        if (this.searchQuery.trim()) {
          const query = this.searchQuery.toLowerCase();
          allPlayers = allPlayers.filter(p =>
            p.name.toLowerCase().includes(query) ||
            p.number.toString().includes(query)
          );
        }

        return allPlayers;
      }

      addPlayer(position, depth, player) {
        this.saveStateForUndo();
        if (!this.depthChart[position]) {
          this.depthChart[position] = [];
        }
        this.depthChart[position] = [...this.depthChart[position]];
        this.depthChart[position][depth] = player;
        this.showPlayerModal = false;
        this.selectedSlot = null;
        this.searchQuery = '';
        this.autoSave();
        this.render();
      }

      removePlayer(pos, depth) {
        this.saveStateForUndo();
        this.depthChart[pos] = [...this.depthChart[pos]];
        this.depthChart[pos][depth] = null;
        this.autoSave();
        this.render();
      }

      handleDragStart(player, position, depth) {
        this.draggedPlayer = { player, fromPosition: position, fromDepth: depth };
      }

      handleDragOver(position, depth, event) {
        event.preventDefault();
        this.dragOverPosition = { position, depth };
        this.render();
      }

      handleDragLeave() {
        this.dragOverPosition = null;
        this.render();
      }

      handleDrop(toPosition, toDepth) {
        if (!this.draggedPlayer) return;

        const { player, fromPosition, fromDepth } = this.draggedPlayer;
        const fromPosBase = fromPosition.replace('-R', '').split('-')[0];
        const toPosBase = toPosition.replace('-R', '').split('-')[0];

        const positionGroups = {
          'WR': ['WR'],
          'OL': ['OT', 'OG', 'C'],
          'CB': ['CB', 'DB', 'S'],
          'S': ['S', 'DB', 'CB'],
          'LB': ['LB'],
          'DE': ['DE'],
          'DT': ['DT'],
          'QB': ['QB'],
          'RB': ['RB'],
          'TE': ['TE'],
          'K': ['K'],
          'P': ['P'],
          'LS': ['LS']
        };

        let canDrop = false;
        for (const [group, positions] of Object.entries(positionGroups)) {
          if (positions.some(p => fromPosBase.includes(p) || fromPosition.includes(p)) &&
              positions.some(p => toPosBase.includes(p) || toPosition.includes(p))) {
            canDrop = true;
            break;
          }
        }

        if (canDrop) {
          this.saveStateForUndo();
          const targetPlayer = this.depthChart[toPosition]?.[toDepth];
          this.depthChart[fromPosition] = [...(this.depthChart[fromPosition] || [])];
          this.depthChart[toPosition] = [...(this.depthChart[toPosition] || [])];
          this.depthChart[toPosition][toDepth] = player;
          this.depthChart[fromPosition][fromDepth] = targetPlayer || null;
          this.autoSave();
        }

        this.draggedPlayer = null;
        this.dragOverPosition = null;
        this.render();
      }

      setupKeyboardShortcuts() {
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            if (this.showPlayerModal) {
              this.showPlayerModal = false;
              this.selectedSlot = null;
              this.searchQuery = '';
              this.render();
            } else if (this.showImportModal) {
              this.showImportModal = false;
              this.importText = '';
              this.importMessage = '';
              this.render();
            } else if (this.showResetModal) {
              this.showResetModal = false;
              this.render();
            } else if (this.showTeamSettingsModal) {
              this.showTeamSettingsModal = false;
              this.render();
            } else if (this.showAppResetModal) {
              this.showAppResetModal = false;
              this.render();
            }
          }

          if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
            e.preventDefault();
            this.undo();
          }

          if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) {
            e.preventDefault();
            this.redo();
          }

          if (e.key === 'd' && !this.showPlayerModal && !this.showImportModal && !this.showResetModal && !this.showTeamSettingsModal && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
            this.toggleDarkMode();
          }

          if (!this.showPlayerModal && !this.showImportModal && !this.showResetModal && !this.showTeamSettingsModal && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
            if (e.key === 'ArrowUp' && this.depthLevel > 0) {
              this.depthLevel--;
              this.render();
            } else if (e.key === 'ArrowDown' && this.depthLevel < 2) {
              this.depthLevel++;
              this.render();
            } else if (e.key === 'ArrowLeft') {
              const tabs = ['offense', 'defense', 'special'];
              const currentIndex = tabs.indexOf(this.activeTab);
              if (currentIndex > 0) {
                this.activeTab = tabs[currentIndex - 1];
                this.render();
              }
            } else if (e.key === 'ArrowRight') {
              const tabs = ['offense', 'defense', 'special'];
              const currentIndex = tabs.indexOf(this.activeTab);
              if (currentIndex < tabs.length - 1) {
                this.activeTab = tabs[currentIndex + 1];
                this.render();
              }
            }
          }
        });
      }

      printChart() {
        window.print();
      }

      // Get positions for current tab based on selected formation
      getPositions(tab) {
        if (tab === "offense") {
          return FORMATIONS.offense[this.offenseFormation]?.positions || POSITIONS.offense;
        } else if (tab === "defense") {
          return FORMATIONS.defense[this.defenseFormation]?.positions || POSITIONS.defense;
        }
        return POSITIONS[tab] || [];
      }

      // Change formation and reinitialize positions
      changeFormation(type, formation) {
        if (type === "offense") {
          this.offenseFormation = formation;
          localStorage.setItem("depth-chart-offense-formation", formation);
        } else if (type === "defense") {
          this.defenseFormation = formation;
          localStorage.setItem("depth-chart-defense-formation", formation);
        }
        this.render();
      }

      // Load saved formations
      loadFormations() {
        const savedOffense = localStorage.getItem("depth-chart-offense-formation");
        const savedDefense = localStorage.getItem("depth-chart-defense-formation");
        if (savedOffense && FORMATIONS.offense[savedOffense]) this.offenseFormation = savedOffense;
        if (savedDefense && FORMATIONS.defense[savedDefense]) this.defenseFormation = savedDefense;
      }

      getPlayerLastName(name) {
        const suffixes = ["Jr.", "Sr.", "II", "III", "IV", "V"];
        const parts = name.split(" ");
        let lastPart = parts.pop();
        if (suffixes.includes(lastPart) && parts.length > 0) {
          lastPart = parts.pop();
        }
        return lastPart;
      }

      getPlayerInitials(name) {
        return name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
      }

      // Get display name for a depth chart slot
      getSlotDisplayName(slotCode) {
        const slotNames = {
          'QB': 'QB',
          'RB': 'RB',
          'FB': 'FB',
          'WR-X': 'WR-X',
          'WR-Z': 'WR-Z',
          'WR-SLOT': 'Slot WR',
          'WR-SLOT-R': 'Slot WR',
          'TE': 'TE',
          'TE-2': 'TE2',
          'OT': 'LT',
          'OT-R': 'RT',
          'OG': 'LG',
          'OG-R': 'RG',
          'C': 'C',
          'DE-1': 'DE',
          'DE-2': 'DE',
          'DT-1': 'DT',
          'DT-2': 'DT',
          'NT': 'NT',
          'LB-ILB': 'ILB',
          'LB-OLB': 'OLB',
          'CB-X': 'CB',
          'CB-Y': 'CB',
          'CB-SLOT': 'NCB',
          'S-FS': 'FS',
          'S-SS': 'SS',
          'K': 'K',
          'P': 'P',
          'LS': 'LS'
        };
        return slotNames[slotCode] || slotCode;
      }

      // Get roster statistics by position group
      getRosterStats() {
        const stats = {};
        const groups = {
          'QB': ['QB'],
          'RB': ['RB', 'FB'],
          'WR': ['WR'],
          'TE': ['TE'],
          'OL': ['OL', 'OT', 'OG', 'C'],
          'DL': ['DL', 'DT', 'DE', 'NT', 'EDGE'],
          'LB': ['LB', 'ILB', 'OLB', 'MLB'],
          'DB': ['DB', 'CB', 'S', 'SS', 'FS'],
          'K': ['K', 'PK'],
          'P': ['P'],
          'LS': ['LS', 'SNP'],
          'RET': ['WR', 'RB', 'DB', 'CB', 'S'] // Returners can be WR, RB, or DB
        };

        for (const [group, positions] of Object.entries(groups)) {
          stats[group] = this.roster.filter(p => positions.includes(p.position)).length;
        }
        return stats;
      }

      // Get progress statistics - positions filled vs total
      getProgressStats() {
        let filled = 0;
        let total = 0;

        // Count positions for current formation
        const offensePositions = FORMATIONS.offense[this.offenseFormation]?.positions || [];
        const defensePositions = FORMATIONS.defense[this.defenseFormation]?.positions || [];
        const specialPositions = POSITIONS.special || [];

        const allPositions = [...offensePositions, ...defensePositions, ...specialPositions];

        for (const pos of allPositions) {
          const posKey = pos.isRight ? `${pos.code}-R` : pos.code;
          const depth = pos.depth || 3;

          for (let d = 0; d < Math.min(depth, 3); d++) {
            total++;
            if (this.depthChart[posKey]?.[d]) {
              filled++;
            }
          }
        }

        return { filled, total, percentage: total > 0 ? Math.round((filled / total) * 100) : 0 };
      }

      // Detect position mismatches between roster and depth chart needs
      getPositionMismatches() {
        const mismatches = [];
        const stats = this.getRosterStats();

        // Check for common mismatches
        if (stats['DL'] > 0 && stats['DL'] === this.roster.filter(p => p.position === 'DL').length) {
          // All defensive linemen are labeled as generic "DL"
          const dlCount = stats['DL'];
          mismatches.push({
            type: 'dl_generic',
            message: `${dlCount} player${dlCount > 1 ? 's' : ''} listed as "DL" - they'll appear in both DE and DT positions`,
            count: dlCount
          });
        }

        // Check for missing position groups
        const neededGroups = ['QB', 'RB', 'WR', 'TE', 'OL', 'DL', 'LB', 'DB'];
        for (const group of neededGroups) {
          if (stats[group] === 0) {
            mismatches.push({
              type: 'missing',
              message: `No ${group} players in roster`,
              group
            });
          }
        }

        return mismatches;
      }

      // Get available positions for a player position type
      getMatchingDepthChartPositions(playerPosition) {
        const mapping = {
          'QB': ['QB'],
          'RB': ['RB', 'FB'],
          'FB': ['FB', 'RB'],
          'WR': ['WR-X', 'WR-Z', 'WR-SLOT', 'WR-SLOT-R'],
          'TE': ['TE', 'TE-2'],
          'OL': ['OT', 'OG', 'C'],
          'OT': ['OT'],
          'OG': ['OG'],
          'C': ['C'],
          'DL': ['DE-1', 'DE-2', 'DT-1', 'DT-2'],
          'DE': ['DE-1', 'DE-2'],
          'DT': ['DT-1', 'DT-2'],
          'EDGE': ['DE-1', 'DE-2'],
          'LB': ['LB-ILB', 'LB-OLB'],
          'ILB': ['LB-ILB'],
          'OLB': ['LB-OLB'],
          'CB': ['CB-X', 'CB-Y', 'CB-SLOT'],
          'DB': ['CB-X', 'CB-Y', 'CB-SLOT', 'S-FS', 'S-SS'],
          'S': ['S-FS', 'S-SS'],
          'FS': ['S-FS'],
          'SS': ['S-SS'],
          'K': ['K'],
          'P': ['P'],
          'LS': ['LS']
        };
        return mapping[playerPosition] || [];
      }

      // Open depth reorder modal for a position group
      openDepthReorder(positionGroup) {
        this.selectedPositionGroup = positionGroup;
        this.showDepthReorderModal = true;
        this.render();
      }

      // Get all players for a position group
      getPlayersForGroup(group) {
        const groupMapping = {
          'QB': ['QB'],
          'RB': ['RB', 'FB'],
          'WR': ['WR'],
          'TE': ['TE'],
          'OL': ['OL', 'OT', 'OG', 'C'],
          'DL': ['DL', 'DT', 'DE', 'NT', 'EDGE'],
          'LB': ['LB', 'ILB', 'OLB', 'MLB'],
          'DB': ['DB', 'CB', 'S', 'SS', 'FS'],
          'K': ['K', 'PK'],
          'P': ['P'],
          'LS': ['LS', 'SNP'],
          'RET': ['WR', 'RB', 'DB', 'CB', 'S', 'FB'] // Returners can be skill players
        };
        const positions = groupMapping[group] || [group];
        return this.roster.filter(p => positions.includes(p.position));
      }

      // Get depth chart slots for a position group
      getDepthSlotsForGroup(group) {
        const slotMapping = {
          'QB': [{ key: 'QB', name: 'QB', depth: 3 }],
          'RB': [{ key: 'RB', name: 'RB', depth: 3 }, { key: 'FB', name: 'FB', depth: 3 }],
          'WR': [
            { key: 'WR-X', name: 'X (Split End)', depth: 3 },
            { key: 'WR-Z', name: 'Z (Flanker)', depth: 3 },
            { key: 'WR-SLOT', name: 'Slot L', depth: 3 },
            { key: 'WR-SLOT-R', name: 'Slot R', depth: 3 }
          ],
          'TE': [{ key: 'TE', name: 'TE', depth: 3 }, { key: 'TE-2', name: 'TE2', depth: 3 }],
          'OL': [
            { key: 'OT', name: 'LT', depth: 3 },
            { key: 'OG', name: 'LG', depth: 3 },
            { key: 'C', name: 'C', depth: 3 },
            { key: 'OG-R', name: 'RG', depth: 3 },
            { key: 'OT-R', name: 'RT', depth: 3 }
          ],
          'DL': [
            { key: 'DE-1', name: 'DE (L)', depth: 3 },
            { key: 'DT-1', name: 'DT (L)', depth: 3 },
            { key: 'NT', name: 'NT (Nose)', depth: 3 },
            { key: 'DT-2', name: 'DT (R)', depth: 3 },
            { key: 'DE-2', name: 'DE (R)', depth: 3 }
          ],
          'LB': [
            { key: 'LB-OLB', name: 'OLB/WILL', depth: 3 },
            { key: 'LB-ILB', name: 'ILB/MIKE', depth: 3 }
          ],
          'DB': [
            { key: 'CB-X', name: 'CB1', depth: 3 },
            { key: 'CB-Y', name: 'CB2', depth: 3 },
            { key: 'CB-SLOT', name: 'Nickel', depth: 3 },
            { key: 'S-FS', name: 'FS', depth: 3 },
            { key: 'S-SS', name: 'SS', depth: 3 }
          ],
          'K': [{ key: 'K', name: 'K', depth: 3 }, { key: 'KOS', name: 'Kickoff', depth: 3 }],
          'P': [{ key: 'P', name: 'P', depth: 3 }, { key: 'H', name: 'Holder', depth: 3 }],
          'LS': [{ key: 'LS', name: 'LS', depth: 3 }],
          'RET': [{ key: 'KR', name: 'Kick Return', depth: 3 }, { key: 'PR', name: 'Punt Return', depth: 3 }]
        };
        return slotMapping[group] || [];
      }

      // Assign player to a slot from reorder modal
      assignFromReorder(slotKey, depthIndex, player) {
        this.saveStateForUndo();
        if (!this.depthChart[slotKey]) {
          this.depthChart[slotKey] = [];
        }
        this.depthChart[slotKey][depthIndex] = player;
        this.autoSave();
        this.render();
      }

      // Remove player from slot in reorder modal
      removeFromReorder(slotKey, depthIndex) {
        this.saveStateForUndo();
        if (this.depthChart[slotKey]) {
          this.depthChart[slotKey][depthIndex] = null;
        }
        this.autoSave();
        this.render();
      }

      render() {
        const app = document.getElementById('app');

        if (this.loading) {
          app.innerHTML = this.renderLoadingState();
          return;
        }

        app.innerHTML = `
          ${this.readOnlyMode && !this._shareBannerDismissed ? `
            <div class="bg-blue-600 text-white py-3 px-4 text-center text-sm font-semibold flex items-center justify-center gap-3 flex-wrap">
              <span>You're viewing a shared depth chart.</span>
              <button onclick="app.loadSharedIntoEditor()" class="bg-white text-blue-600 px-4 py-1.5 rounded-lg font-bold hover:bg-blue-50 transition-colors text-sm">Load into Editor</button>
              <button onclick="app.dismissShareBanner()" class="text-white/80 hover:text-white underline text-sm">Dismiss</button>
            </div>
          ` : ''}
          <div class="max-w-7xl mx-auto p-4">
            ${this.renderHeader()}
            ${!this.readOnlyMode ? this.renderButtons() : ''}
            ${this.renderTabs()}
            ${!this.readOnlyMode ? this.renderMobileControls() : ''}
            <div class="desktop-only">
              ${this.activeTab !== 'special' ? this.renderDepthSelector() : ''}
              ${!this.readOnlyMode && this.activeTab !== 'special' ? this.renderFormationSelector() : ''}
            </div>
            ${this.renderField()}
            ${!this.readOnlyMode ? this.renderKeyboardHints() : ''}
          </div>
          ${!this.readOnlyMode && this.showOnboarding ? this.renderOnboarding() : ''}
          ${!this.readOnlyMode && this.showSetupModal ? this.renderSetupModal() : ''}
          ${!this.readOnlyMode && this.showTeamSettingsModal ? this.renderTeamSettingsModal() : ''}
          ${!this.readOnlyMode && this.showPlayerModal ? this.renderPlayerModal() : ''}
          ${!this.readOnlyMode && this.showImportModal ? this.renderImportModal() : ''}
          ${!this.readOnlyMode && this.showResetModal ? this.renderResetModal() : ''}
          ${!this.readOnlyMode && this.showAppResetModal ? this.renderAppResetModal() : ''}
          ${!this.readOnlyMode && this.showDepthReorderModal ? this.renderDepthReorderModal() : ''}
          ${this.toastMessage ? `
            <div class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-gray-900 dark:bg-gray-100 text-white dark:text-gray-900 px-6 py-3 rounded-xl shadow-2xl text-sm font-semibold z-50 animate-fadeIn flex items-center gap-2">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
              ${escapeHtml(this.toastMessage)}
            </div>
          ` : ''}
        `;
        this.attachEventListeners();
      }

      renderLoadingState() {
        return `
          <div class="max-w-7xl mx-auto p-4">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-6 border-4 border-gray-300">
              <div class="flex items-center gap-4">
                <div class="w-16 h-16 skeleton rounded-full"></div>
                <div class="flex-1">
                  <div class="h-8 skeleton rounded mb-2 w-3/4"></div>
                  <div class="h-4 skeleton rounded w-1/2"></div>
                </div>
              </div>
            </div>
            <div class="flex gap-3 mb-6">
              ${[1,2,3,4].map(() => `<div class="h-10 w-24 skeleton rounded-lg"></div>`).join('')}
            </div>
            <div class="h-12 skeleton rounded-lg mb-4"></div>
            <div class="h-[500px] skeleton rounded-lg"></div>
          </div>
        `;
      }

      renderOnboarding() {
        return `
          <div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden">
              <div class="p-6 text-center" style="background: ${this.team.primaryColor}; color: white;">
                <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center mx-auto mb-4">
                  <span style="color: ${this.team.primaryColor};" class="font-display font-bold text-2xl">CFB</span>
                </div>
                <h2 class="font-display text-3xl font-bold">College Football Depth Chart</h2>
              </div>
              <div class="p-6">
                <div class="space-y-4">
                  <div class="flex items-start gap-3">
                    <div class="w-8 h-8 text-white rounded-full flex items-center justify-center font-bold flex-shrink-0" style="background: ${this.team.primaryColor};">1</div>
                    <div>
                      <h3 class="font-semibold text-gray-900 dark:text-white">Import your roster</h3>
                      <p class="text-gray-600 dark:text-gray-400 text-sm">Paste a roster URL or manually enter players</p>
                    </div>
                  </div>
                  <div class="flex items-start gap-3">
                    <div class="w-8 h-8 text-white rounded-full flex items-center justify-center font-bold flex-shrink-0" style="background: ${this.team.primaryColor};">2</div>
                    <div>
                      <h3 class="font-semibold text-gray-900 dark:text-white">Click positions to assign</h3>
                      <p class="text-gray-600 dark:text-gray-400 text-sm">Select players for each position on the field</p>
                    </div>
                  </div>
                  <div class="flex items-start gap-3">
                    <div class="w-8 h-8 text-white rounded-full flex items-center justify-center font-bold flex-shrink-0" style="background: ${this.team.primaryColor};">3</div>
                    <div>
                      <h3 class="font-semibold text-gray-900 dark:text-white">Drag to rearrange</h3>
                      <p class="text-gray-600 dark:text-gray-400 text-sm">Drag players between positions to swap them</p>
                    </div>
                  </div>
                </div>
              </div>
              <div class="p-4 border-t dark:border-gray-700">
                <button onclick="app.dismissOnboarding()" class="w-full text-white py-3 rounded-lg font-display font-semibold text-lg transition-colors" style="background: ${this.team.primaryColor};">
                  Get Started
                </button>
              </div>
            </div>
          </div>
        `;
      }

      renderSetupModal() {
        const importTab = this.setupImportTab || 'url';
        return `
          <div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 overflow-y-auto">
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-2xl w-full overflow-hidden my-4">
              <div class="p-6 text-center text-white" style="background: ${this.team.primaryColor};">
                <h2 class="font-display text-2xl font-bold">Setup Your Team</h2>
                <p class="opacity-80">Import a roster to get started</p>
              </div>
              <div class="p-6">
                <div class="mb-6">
                  <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Team Name</label>
                  <input
                    type="text"
                    id="teamNameInput"
                    placeholder="e.g., Ohio State Buckeyes"
                    value="${this.team.name !== 'Your Team' ? escapeHtml(this.team.name) : ''}"
                    class="w-full px-4 py-2 border-2 border-gray-200 dark:border-gray-600 rounded-lg focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                  />
                </div>

                <div class="mb-6">
                  <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Primary Color</label>
                  <div class="flex gap-3">
                    <input
                      type="color"
                      id="teamColorInput"
                      value="${this.team.primaryColor}"
                      class="w-12 h-10 rounded cursor-pointer"
                    />
                    <input
                      type="text"
                      id="teamColorText"
                      value="${this.team.primaryColor}"
                      placeholder="#1a1a2e"
                      class="flex-1 px-4 py-2 border-2 border-gray-200 dark:border-gray-600 rounded-lg focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-mono"
                    />
                  </div>
                </div>

                <div class="border-t dark:border-gray-700 pt-6">
                  <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">Import Roster</label>

                  <!-- Import Method Tabs -->
                  <div class="flex mb-4 border-b dark:border-gray-600">
                    <button onclick="app.setupImportTab = 'url'; app.render()" class="px-4 py-2 font-semibold text-sm ${importTab === 'url' ? 'border-b-2 text-gray-900 dark:text-white' : 'text-gray-500 dark:text-gray-400'}" style="${importTab === 'url' ? `border-color: ${this.team.primaryColor};` : ''}">
                      <span class="mr-1">üîó</span> From URL
                    </button>
                    <button onclick="app.setupImportTab = 'manual'; app.render()" class="px-4 py-2 font-semibold text-sm ${importTab === 'manual' ? 'border-b-2 text-gray-900 dark:text-white' : 'text-gray-500 dark:text-gray-400'}" style="${importTab === 'manual' ? `border-color: ${this.team.primaryColor};` : ''}">
                      <span class="mr-1">üìù</span> Manual Entry
                    </button>
                  </div>

                  ${importTab === 'url' ? `
                    <!-- URL Import -->
                    <div>
                      <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
                        Enter your team's roster page URL (works with most college athletics sites)
                      </p>
                      <input
                        type="url"
                        id="rosterUrlInput"
                        placeholder="https://ohiostatebuckeyes.com/sports/football/roster"
                        class="w-full px-4 py-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white mb-4"
                      />

                      <button
                        onclick="app.fetchRosterFromUrl()"
                        class="w-full py-3 rounded-lg font-display font-semibold text-white transition-colors flex items-center justify-center gap-2 ${this.fetchingRoster ? 'opacity-70 cursor-not-allowed' : ''}"
                        style="background: ${this.team.primaryColor};"
                        ${this.fetchingRoster ? 'disabled' : ''}
                      >
                        ${this.fetchingRoster ? `
                          <svg class="animate-spin h-5 w-5" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"/>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/>
                          </svg>
                          Fetching Roster...
                        ` : `
                          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/>
                          </svg>
                          Fetch Roster
                        `}
                      </button>

                      <p class="text-xs text-gray-500 dark:text-gray-400 mt-3 text-center">
                        Works with Sidearm Sports sites (most college athletics). If import fails, use Manual Entry.
                      </p>
                    </div>
                  ` : `
                    <!-- Manual Import -->
                    <div>
                      <p class="text-xs text-gray-500 dark:text-gray-400 mb-2">Format: #Number Name Position Year (one player per line)</p>
                      <textarea
                        id="setupRosterTextarea"
                        placeholder="#1 John Smith QB Sr.&#10;#24 Mike Johnson RB Jr.&#10;#7 David Wilson WR So.&#10;‚Ä¶"
                        class="w-full h-48 p-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg font-mono text-sm focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                      ></textarea>
                    </div>
                  `}

                  ${this.importMessage ? `
                    <div class="mt-3 p-2 rounded ${this.importMessage.includes('Success') ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'} text-sm">
                      ${escapeHtml(this.importMessage)}
                    </div>
                  ` : ''}
                </div>
              </div>
              <div class="p-4 border-t dark:border-gray-700 bg-gray-50 dark:bg-gray-900 flex gap-3">
                <button
                  onclick="app.saveSetup()"
                  class="flex-1 text-white px-4 py-3 rounded-lg font-display font-semibold transition-colors"
                  style="background: ${this.team.primaryColor};"
                >
                  ${importTab === 'url' ? 'Continue' : 'Save & Import'}
                </button>
                <button
                  onclick="app.showSetupModal = false; app.render()"
                  class="px-4 py-3 bg-white dark:bg-gray-800 border-2 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg font-semibold hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                >
                  Skip
                </button>
              </div>
            </div>
          </div>
        `;
      }

      async fetchRosterFromUrl() {
        const urlInput = document.getElementById('rosterUrlInput');
        const url = urlInput?.value?.trim();

        if (!url) {
          this.importMessage = 'Please enter a roster URL';
          this.render();
          return;
        }

        // Validate URL format
        try {
          new URL(url);
        } catch (e) {
          this.importMessage = 'Please enter a valid URL';
          this.render();
          return;
        }

        this.fetchingRoster = true;
        this.importMessage = '';
        this.render();

        try {
          const response = await fetch('/api/scrape', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url })
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.error || 'Failed to fetch roster');
          }

          // Update team info
          if (data.team) {
            this.team.name = data.team.name || this.team.name;
            this.team.primaryColor = data.team.primaryColor || this.team.primaryColor;
            this.team.rosterUrl = data.team.rosterUrl || url;
            this.saveTeam();
          }

          // Update roster
          if (data.roster && data.roster.length > 0) {
            this.roster = data.roster;
            localStorage.setItem('generic-roster', JSON.stringify(this.roster));
            this.importMessage = `Success! Imported ${data.roster.length} players from ${data.team?.name || 'roster'}`;
            this.showSetupModal = false;
          } else {
            this.importMessage = 'No players found on that page. Try using Manual Entry.';
          }

        } catch (error) {
          console.error('Fetch error:', error);
          this.importMessage = error.message || 'Failed to fetch roster. Try using Manual Entry.';
        } finally {
          this.fetchingRoster = false;
          this.render();
        }
      }

      saveSetup() {
        const nameInput = document.getElementById('teamNameInput');
        const colorInput = document.getElementById('teamColorText');
        const rosterTextarea = document.getElementById('setupRosterTextarea');

        if (nameInput.value.trim()) {
          this.team.name = nameInput.value.trim();
        }
        if (colorInput.value.trim()) {
          this.team.primaryColor = colorInput.value.trim();
        }
        this.saveTeam();

        if (rosterTextarea.value.trim()) {
          this.importText = rosterTextarea.value;
          this.importRoster();
        } else {
          this.showSetupModal = false;
          this.render();
        }
      }

      renderTeamSettingsModal() {
        return `
          <div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4" onclick="if(event.target === this) { app.showTeamSettingsModal = false; app.render(); }">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full overflow-hidden">
              <div class="p-4 text-white flex items-center justify-between" style="background: ${this.team.primaryColor};">
                <h2 class="font-display text-xl font-bold">Team Settings</h2>
                <button onclick="app.showTeamSettingsModal = false; app.render()" class="text-white/80 hover:text-white" aria-label="Close settings">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                  </svg>
                </button>
              </div>
              <div class="p-4">
                <div class="mb-4">
                  <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Team Name</label>
                  <input
                    type="text"
                    id="settingsTeamName"
                    value="${escapeHtml(this.team.name)}"
                    class="w-full px-4 py-2 border-2 border-gray-200 dark:border-gray-600 rounded-lg focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                  />
                </div>
                <div class="mb-4">
                  <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Primary Color</label>
                  <div class="flex gap-3">
                    <input type="color" id="settingsTeamColor" value="${this.team.primaryColor}" class="w-12 h-10 rounded cursor-pointer"/>
                    <input type="text" id="settingsTeamColorText" value="${this.team.primaryColor}" class="flex-1 px-4 py-2 border-2 border-gray-200 dark:border-gray-600 rounded-lg font-mono bg-white dark:bg-gray-700 text-gray-900 dark:text-white"/>
                  </div>
                </div>
              </div>
              <div class="p-4 border-t dark:border-gray-700 bg-gray-50 dark:bg-gray-900">
                <button onclick="app.saveTeamSettings()" class="w-full text-white py-3 rounded-lg font-display font-semibold" style="background: ${this.team.primaryColor};">
                  Save Changes
                </button>
              </div>
              <div class="p-4 border-t dark:border-gray-700">
                <p class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Backup &amp; Restore</p>
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">Save or restore your complete depth chart data</p>
                <div class="flex gap-2">
                  <button onclick="app.exportFullBackup()" class="flex-1 flex items-center justify-center gap-2 py-2.5 rounded-lg font-semibold border-2 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-sm">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
                    Export Backup
                  </button>
                  <button onclick="app.importFullBackup()" class="flex-1 flex items-center justify-center gap-2 py-2.5 rounded-lg font-semibold border-2 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-sm">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>
                    Import Backup
                  </button>
                </div>
              </div>
              <div class="p-4 border-t dark:border-gray-700">
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">Clear all data and start fresh with a new team</p>
                <button onclick="app.resetApp()" class="w-full py-3 rounded-lg font-display font-semibold border-2 border-red-500 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors">
                  Reset App
                </button>
              </div>
            </div>
          </div>
        `;
      }

      saveTeamSettings() {
        const nameInput = document.getElementById('settingsTeamName');
        const colorInput = document.getElementById('settingsTeamColorText');
        if (nameInput.value.trim()) this.team.name = nameInput.value.trim();
        if (colorInput.value.trim()) this.team.primaryColor = colorInput.value.trim();
        this.saveTeam();
        this.showTeamSettingsModal = false;
        this.render();
      }

      renderHeader() {
        const stats = this.getRosterStats();
        const progress = this.getProgressStats();
        const mismatches = this.getPositionMismatches();
        const totalPlayers = this.roster.length;

        return `
          <div class="bg-white dark:bg-gray-800 text-gray-900 dark:text-white rounded-2xl shadow-xl p-6 mb-6 border-l-4 animate-fadeIn relative overflow-hidden" style="border-color: ${this.team.primaryColor}; box-shadow: 0 10px 40px -10px rgba(0,0,0,0.2), 0 0 0 1px rgba(0,0,0,0.05);">
            <div class="absolute top-0 right-0 w-64 h-64 opacity-5 dark:opacity-10" style="background: radial-gradient(circle, ${this.team.primaryColor} 0%, transparent 70%);"></div>
            <div class="flex items-center justify-between flex-wrap gap-4 relative">
              <div class="flex items-center gap-5">
                <div class="w-18 h-18 rounded-2xl flex items-center justify-center text-white font-display text-2xl flex-shrink-0 shadow-lg" style="background: linear-gradient(135deg, ${this.team.primaryColor} 0%, ${this.team.primaryColor}dd 100%); width: 72px; height: 72px;">
                  <span>${escapeHtml(this.team.name.split(' ').map(w => w[0]).join('').substring(0, 3))}</span>
                </div>
                <div>
                  <h1 class="font-display text-4xl font-bold mb-1" style="letter-spacing: 0.05em;">${escapeHtml(this.team.name.toUpperCase())}</h1>
                  <p class="text-gray-500 dark:text-gray-400 font-medium text-sm uppercase tracking-wider">${this.readOnlyMode ? 'Shared Depth Chart' : 'Interactive Depth Chart Builder'}</p>
                </div>
              </div>
              <div class="flex items-center gap-3">
                ${this.saving ? `
                  <span class="text-green-600 dark:text-green-400 text-sm font-semibold flex items-center gap-2 animate-savedPop">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                    Auto-saved
                  </span>
                ` : ''}
                ${this.readOnlyMode ? `
                  <span class="text-xs font-semibold text-gray-400 dark:text-gray-500 uppercase tracking-wider">View Only</span>
                ` : `
                <button onclick="app.showTeamSettingsModal = true; app.render()" class="p-2.5 rounded-xl bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 btn-hover no-print" title="Team settings" aria-label="Team settings">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-gray-600 dark:text-gray-300">
                    <circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/>
                  </svg>
                </button>
                `}
                <button onclick="app.toggleDarkMode()" class="p-2.5 rounded-xl bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 btn-hover no-print" title="Toggle dark mode (D)" aria-label="Toggle dark mode">
                  ${this.darkMode ? `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-yellow-500">
                      <circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                    </svg>
                  ` : `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-gray-600">
                      <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                    </svg>
                  `}
                </button>
              </div>
            </div>

            ${this.readOnlyMode ? `
              <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                <div class="mb-3">
                  <div class="flex items-center justify-between mb-1">
                    <span class="text-sm font-semibold text-gray-700 dark:text-gray-300">Depth Chart Progress</span>
                    <span class="text-sm font-bold" style="color: ${this.team.primaryColor};">${progress.filled}/${progress.total} positions (${progress.percentage}%)</span>
                  </div>
                  <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                    <div class="h-2.5 rounded-full transition-all duration-300" style="width: ${progress.percentage}%; background: ${this.team.primaryColor};"></div>
                  </div>
                </div>
              </div>
            ` : totalPlayers > 0 ? `
              <!-- Roster Stats & Progress -->
              <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                <!-- Progress Bar -->
                <div class="mb-3">
                  <div class="flex items-center justify-between mb-1">
                    <span class="text-sm font-semibold text-gray-700 dark:text-gray-300">Depth Chart Progress</span>
                    <span class="text-sm font-bold" style="color: ${this.team.primaryColor};">${progress.filled}/${progress.total} positions (${progress.percentage}%)</span>
                  </div>
                  <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                    <div class="h-2.5 rounded-full transition-all duration-300" style="width: ${progress.percentage}%; background: ${this.team.primaryColor};"></div>
                  </div>
                </div>

                <!-- Roster Stats Pills (clickable for quick reorder) -->
                <div class="flex flex-wrap gap-2 items-center">
                  <span class="text-sm font-semibold text-gray-500 dark:text-gray-400 py-1">ROSTER (${totalPlayers}):</span>
                  ${Object.entries(stats).filter(([_, count]) => count > 0).map(([pos, count]) => `
                    <button
                      onclick="app.openDepthReorder('${pos}')"
                      class="inline-flex items-center px-3 py-2 rounded-full text-sm font-semibold transition-colors hover:ring-2 hover:ring-offset-2 ${
                        count > 0 ? 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600' : 'bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400'
                      }"
                      style="--tw-ring-color: ${this.team.primaryColor};"
                      title="Click to reorder ${pos} depth"
                    >
                      ${pos}: ${count}
                    </button>
                  `).join('')}
                  <span class="text-sm text-gray-400 dark:text-gray-500 ml-2">(click to reorder)</span>
                </div>

                <!-- Position Mismatch Warnings -->
                ${mismatches.length > 0 ? `
                  <div class="mt-3 space-y-2">
                    ${mismatches.slice(0, 3).map(m => `
                      <div class="flex items-start gap-2 text-sm ${m.type === 'missing' ? 'text-amber-600 dark:text-amber-400' : 'text-blue-600 dark:text-blue-400'}">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="flex-shrink-0 mt-0.5">
                          ${m.type === 'missing'
                            ? '<path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>'
                            : '<circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>'
                          }
                        </svg>
                        <span>${m.message}</span>
                      </div>
                    `).join('')}
                  </div>
                ` : ''}
              </div>
            ` : `
              <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                <p class="text-sm text-gray-500 dark:text-gray-400 flex items-center gap-2">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                  No roster imported yet. Click <strong>Import</strong> to add players.
                </p>
              </div>
            `}
          </div>
        `;
      }

      renderButtons() {
        return `
          <div class="flex flex-wrap gap-2 sm:gap-3 mb-4 sm:mb-6 no-print">
            <button onclick="app.undo()" class="flex items-center justify-center gap-2 bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-white border-2 px-2 sm:px-4 py-2 rounded-lg font-semibold transition-colors disabled:opacity-50" style="border-color: ${this.team.primaryColor};" ${this.undoStack.length === 0 ? 'disabled' : ''} title="Undo">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 102.13-9.36L1 10"/></svg>
              <span class="hidden sm:inline">Undo</span>
            </button>
            <button onclick="app.redo()" class="flex items-center justify-center gap-2 bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-white border-2 px-2 sm:px-4 py-2 rounded-lg font-semibold transition-colors disabled:opacity-50" style="border-color: ${this.team.primaryColor};" ${this.redoStack.length === 0 ? 'disabled' : ''} title="Redo">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 11-2.13-9.36L23 10"/></svg>
              <span class="hidden sm:inline">Redo</span>
            </button>
            <div class="w-px bg-gray-300 dark:bg-gray-600 mx-0.5 sm:mx-1 hidden sm:block"></div>
            <button onclick="app.showImportModal = true; app.render()" class="flex items-center justify-center gap-2 bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-white border-2 px-2 sm:px-4 py-2 rounded-lg font-semibold transition-colors" style="border-color: ${this.team.primaryColor};" title="Import">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>
              <span class="hidden sm:inline">Import</span>
            </button>
            <button onclick="app.exportDepthChart()" class="flex items-center justify-center gap-2 bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-white border-2 px-2 sm:px-4 py-2 rounded-lg font-semibold transition-colors" style="border-color: ${this.team.primaryColor};" title="Export">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
              <span class="hidden sm:inline">Export</span>
            </button>
            <button onclick="app.shareAsImage()" class="flex items-center justify-center gap-2 text-white border-2 px-2 sm:px-4 py-2 rounded-lg font-semibold transition-colors" style="background: ${this.team.primaryColor}; border-color: ${this.team.primaryColor};" title="Share as Image">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
              <span class="hidden sm:inline">Image</span>
            </button>
            <button onclick="app.shareViaUrl()" class="flex items-center justify-center gap-2 text-white border-2 px-2 sm:px-4 py-2 rounded-lg font-semibold transition-colors" style="background: ${this.team.primaryColor}; border-color: ${this.team.primaryColor};" title="Copy share link">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
              <span class="hidden sm:inline">Share</span>
            </button>
            <button onclick="app.printChart()" class="flex items-center justify-center gap-2 bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-white border-2 px-2 sm:px-4 py-2 rounded-lg font-semibold transition-colors" style="border-color: ${this.team.primaryColor};" title="Print">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
              <span class="hidden sm:inline">Print</span>
            </button>
            <button onclick="app.showResetConfirmation()" class="flex items-center justify-center gap-2 bg-white dark:bg-gray-800 hover:bg-red-50 dark:hover:bg-red-900/20 text-red-600 dark:text-red-400 border-2 border-red-300 dark:border-red-800 px-2 sm:px-4 py-2 rounded-lg font-semibold transition-colors" title="Reset">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
              <span class="hidden sm:inline">Reset</span>
            </button>
          </div>
        `;
      }

      renderTabs() {
        const tabs = [
          { key: 'offense', label: 'OFFENSE', icon: 'üèà' },
          { key: 'defense', label: 'DEFENSE', icon: 'üõ°Ô∏è' },
          { key: 'special', label: 'SPECIAL TEAMS', icon: '‚≠ê' }
        ];

        return `
          <div class="flex gap-2 mb-4">
            ${tabs.map(tab => `
              <button
                onclick="app.activeTab = '${tab.key}'; app.render()"
                class="px-6 py-3 rounded-t-lg font-display font-semibold text-lg tracking-wide transition-all border-2 ${
                  this.activeTab === tab.key
                    ? 'bg-white dark:bg-gray-800 text-gray-900 dark:text-white shadow-lg -mb-[2px] relative z-10'
                    : 'bg-gray-200/50 dark:bg-gray-700 text-gray-600 dark:text-gray-300 border-transparent hover:bg-gray-200 dark:hover:bg-gray-600'
                }"
                style="${this.activeTab === tab.key ? `border-color: ${this.team.primaryColor};` : ''}"
              >
                <span class="mr-2">${tab.icon}</span>
                ${tab.label}
              </button>
            `).join('')}
          </div>
        `;
      }

      renderDepthSelector() {
        return `
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 mb-4 border-2" style="border-color: ${this.team.primaryColor};">
            <div class="flex items-center gap-4 flex-wrap justify-between">
              <div class="flex items-center gap-4 flex-wrap">
                <span class="font-display font-semibold text-gray-900 dark:text-white">DEPTH LEVEL:</span>
                <div class="flex gap-2">
                  ${!this.twoDeepView ? [0, 1, 2].map(level => `
                    <button
                      onclick="app.depthLevel = ${level}; app.render()"
                      class="px-4 py-2 rounded-lg font-semibold transition-all border-2 ${
                        this.depthLevel === level
                          ? 'text-white shadow-md scale-105'
                          : 'bg-white dark:bg-gray-700 text-gray-700 dark:text-white hover:bg-gray-50 dark:hover:bg-gray-600'
                      }"
                      style="${this.depthLevel === level ? `background: ${this.team.primaryColor}; border-color: ${this.team.primaryColor};` : `border-color: ${this.team.primaryColor};`}"
                    >
                      ${level === 0 ? 'ü•á Starters' : level === 1 ? 'ü•à 2nd String' : 'ü•â 3rd String'}
                    </button>
                  `).join('') : `
                    <span class="px-4 py-2 text-gray-500 dark:text-gray-400 italic">Showing starter + backup</span>
                  `}
                </div>
              </div>
              <button
                onclick="app.toggleTwoDeepView()"
                class="flex items-center gap-2 px-4 py-2 rounded-lg font-semibold transition-all border-2 ${
                  this.twoDeepView
                    ? 'text-white'
                    : 'bg-white dark:bg-gray-700 text-gray-700 dark:text-white hover:bg-gray-50 dark:hover:bg-gray-600'
                }"
                style="${this.twoDeepView ? `background: ${this.team.primaryColor}; border-color: ${this.team.primaryColor};` : `border-color: ${this.team.primaryColor};`}"
                title="Show starter and backup together like official depth charts"
              >
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="8" rx="1"/><rect x="3" y="13" width="18" height="8" rx="1"/>
                </svg>
                Two-Deep View
              </button>
            </div>
          </div>
        `;
      }


      renderFormationSelector() {
        if (this.activeTab === 'special') return '';

        const formations = this.activeTab === 'offense' ? FORMATIONS.offense : FORMATIONS.defense;
        const currentFormation = this.activeTab === 'offense' ? this.offenseFormation : this.defenseFormation;

        return `
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 mb-4 border-2" style="border-color: ${this.team.primaryColor};">
            <div class="flex items-center gap-4 flex-wrap">
              <span class="font-display font-semibold text-gray-900 dark:text-white">FORMATION:</span>
              <select
                onchange="app.changeFormation('${this.activeTab}', this.value)"
                class="px-4 py-2 rounded-lg font-semibold border-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-white cursor-pointer"
                style="border-color: ${this.team.primaryColor};"
              >
                ${Object.entries(formations).map(([key, formation]) => `
                  <option value="${key}" ${key === currentFormation ? 'selected' : ''}>
                    ${formation.name}
                  </option>
                `).join('')}
              </select>
              <span class="text-sm text-gray-500 dark:text-gray-400">
                ${formations[currentFormation]?.description || ''}
              </span>
            </div>
          </div>
        `;
      }

      renderMobileControls() {
        const formations = this.activeTab === 'offense' ? FORMATIONS.offense : FORMATIONS.defense;
        const currentFormation = this.activeTab === 'offense' ? this.offenseFormation : this.defenseFormation;

        return `
          <div class="mobile-controls-bar bg-white dark:bg-gray-800 rounded-lg shadow-md p-3 mb-4 border-2 space-y-3" style="border-color: ${this.team.primaryColor};">
            <!-- Depth Level Row -->
            <div class="flex items-center gap-2">
              <span class="text-xs font-semibold text-gray-600 dark:text-gray-400 w-14 flex-shrink-0">Depth:</span>
              <div class="flex gap-1 flex-1">
                ${!this.twoDeepView ? [0, 1, 2].map(level => `
                  <button
                    onclick="app.depthLevel = ${level}; app.render()"
                    class="flex-1 px-2 py-1.5 rounded text-xs font-semibold transition-all ${
                      this.depthLevel === level
                        ? 'text-white'
                        : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-white'
                    }"
                    style="${this.depthLevel === level ? `background: ${this.team.primaryColor};` : ''}"
                  >
                    ${level === 0 ? '1st' : level === 1 ? '2nd' : '3rd'}
                  </button>
                `).join('') : `
                  <span class="flex-1 text-xs text-gray-500 dark:text-gray-400 italic text-center">Two-Deep Active</span>
                `}
              </div>
              <button
                onclick="app.toggleTwoDeepView()"
                class="px-2 py-1.5 rounded text-xs font-semibold transition-all flex items-center gap-1 ${
                  this.twoDeepView
                    ? 'text-white'
                    : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-white'
                }"
                style="${this.twoDeepView ? `background: ${this.team.primaryColor};` : ''}"
                title="Two-Deep View"
              >
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="8" rx="1"/><rect x="3" y="13" width="18" height="8" rx="1"/>
                </svg>
                2-Deep
              </button>
            </div>

            <!-- Formation Row (only for offense/defense) -->
            ${this.activeTab !== 'special' ? `
              <div class="flex items-center gap-2">
                <span class="text-xs font-semibold text-gray-600 dark:text-gray-400 w-14 flex-shrink-0">Form:</span>
                <select
                  onchange="app.changeFormation('${this.activeTab}', this.value)"
                  class="flex-1 px-2 py-1.5 rounded text-xs font-semibold border bg-white dark:bg-gray-700 text-gray-900 dark:text-white cursor-pointer"
                  style="border-color: ${this.team.primaryColor};"
                >
                  ${Object.entries(formations).map(([key, formation]) => `
                    <option value="${key}" ${key === currentFormation ? 'selected' : ''}>
                      ${formation.name}
                    </option>
                  `).join('')}
                </select>
              </div>
            ` : ''}
          </div>
        `;
      }

      renderField() {
        const positions = this.getPositions(this.activeTab);

        return `
          <div class="field-view field-container bg-gradient-to-b from-green-700 to-green-600 rounded-lg shadow-lg p-4 md:p-8 relative overflow-hidden" style="min-height: 600px;">
            <div class="field-lines absolute inset-0 pointer-events-none"></div>
            <div class="absolute left-2 top-1/2 -translate-y-1/2 text-white/20 font-display text-4xl font-bold">50</div>
            <div class="absolute right-2 top-1/2 -translate-y-1/2 text-white/20 font-display text-4xl font-bold">50</div>
            ${positions.map((pos, index) => this.renderPosition(pos, index)).join('')}
            <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 text-white/20 font-display text-4xl font-bold tracking-widest">
              ${this.activeTab === 'offense' ? 'OFFENSE' : this.activeTab === 'defense' ? 'DEFENSE' : 'SPECIAL TEAMS'}
            </div>
          </div>

          <div class="mobile-list-view bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden">
            <div class="p-3 text-center" style="background: ${this.team.primaryColor};">
              <span class="text-white font-display text-xl font-bold tracking-widest">
                ${this.activeTab === 'offense' ? 'OFFENSE' : this.activeTab === 'defense' ? 'DEFENSE' : 'SPECIAL TEAMS'}
              </span>
            </div>
            <div>
              ${positions.map((pos, index) => this.renderMobilePosition(pos, index)).join('')}
            </div>
          </div>
        `;
      }

      renderPosition(pos, index) {
        const posKey = pos.isRight ? `${pos.code}-R` : pos.code;
        const player = this.depthChart[posKey]?.[this.twoDeepView ? 0 : this.depthLevel];
        const backup = this.twoDeepView ? this.depthChart[posKey]?.[1] : null;
        const isDragOver = this.dragOverPosition?.position === posKey && this.dragOverPosition?.depth === this.depthLevel;
        const status = player ? this.getPlayerStatus(player) : null;
        const note = player ? this.getPlayerNote(player) : '';
        const isBattle = this.positionBattles[posKey];

        return `
          <div class="absolute transform -translate-x-1/2 -translate-y-1/2 position-card" style="left: ${pos.x}%; top: ${pos.y}%;" data-position="${posKey}" data-depth="${this.depthLevel}">
            <div
              class="tooltip ${player ? 'text-white' : 'bg-white dark:bg-gray-700 text-gray-900 dark:text-white border-2'} ${isDragOver ? 'drag-over' : ''} rounded-lg shadow-lg transition-colors cursor-pointer position-card-inner relative"
              style="min-width: 80px; ${player ? `background: ${this.team.primaryColor};` : `border-color: ${this.team.primaryColor};`}"
              data-tooltip="${escapeHtml(pos.fullName)}${status ? ' [' + escapeHtml(status) + ']' : ''}${note ? ' - ' + escapeHtml(note) : ''}"
              ${!this.readOnlyMode ? `onclick="app.selectedSlot = { position: '${posKey}', depth: ${this.twoDeepView ? 0 : this.depthLevel} }; app.showPlayerModal = true; app.render()"` : ''}
              draggable="${!this.readOnlyMode && player ? 'true' : 'false'}"
              ${!this.readOnlyMode ? `
              ondragstart="app.handleDragStart(${player ? JSON.stringify(player).replace(/"/g, '&quot;') : 'null'}, '${posKey}', ${this.twoDeepView ? 0 : this.depthLevel})"
              ondragover="app.handleDragOver('${posKey}', ${this.twoDeepView ? 0 : this.depthLevel}, event)"
              ondragleave="app.handleDragLeave()"
              ondrop="app.handleDrop('${posKey}', ${this.twoDeepView ? 0 : this.depthLevel})"
              ` : ''}
            >
              ${status ? `
                <div class="absolute -top-1 -right-1 px-1 py-0.5 text-[8px] font-bold text-white rounded ${this.getStatusColor(status)}" title="${escapeHtml(status)}">
                  ${escapeHtml(this.getStatusBadge(status))}
                </div>
              ` : ''}
              ${note ? `
                <div class="absolute -top-1 -left-1 w-4 h-4 bg-yellow-400 rounded-full flex items-center justify-center" title="${escapeHtml(note)}">
                  <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="#000" stroke-width="3"><path d="M12 20h9M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                </div>
              ` : ''}
              <div class="px-2 py-1 ${player ? 'border-b border-white/30' : 'border-b-2'} text-center flex items-center justify-center gap-1" style="${!player ? `border-color: ${this.team.primaryColor};` : ''}">
                <div class="text-xs font-display font-bold tracking-wide">${pos.name}</div>
                ${isBattle ? `<span class="text-[9px] bg-yellow-400 text-yellow-900 px-1 rounded font-bold">OR</span>` : ''}
              </div>
              ${player ? `
                <div class="px-2 py-2 text-center relative">
                  <div class="w-8 h-8 mx-auto mb-1 rounded-full bg-white/20 flex items-center justify-center text-xs font-bold">
                    ${escapeHtml(this.getPlayerInitials(player.name))}
                  </div>
                  <div class="font-display font-bold text-sm">#${escapeHtml(player.number)}</div>
                  <div class="text-xs truncate max-w-[70px]" title="${escapeHtml(player.name)}${player.height ? ' &bull; ' + escapeHtml(player.height) : ''}${player.weight ? ' &bull; ' + escapeHtml(player.weight) : ''}">${escapeHtml(this.getPlayerLastName(player.name))}</div>
                  ${!this.twoDeepView && (player.height || player.weight) ? `<div class="text-[9px] opacity-70 mt-0.5">${escapeHtml(player.height) || ''}${player.height && player.weight ? ' ‚Ä¢ ' : ''}${escapeHtml(player.weight) || ''}</div>` : ''}
                  ${this.twoDeepView && backup ? `
                    <div class="absolute -bottom-2 left-1/2 -translate-x-1/2 bg-white/90 text-gray-800 text-[9px] font-bold px-1.5 py-0.5 rounded shadow-sm whitespace-nowrap" title="#${escapeHtml(backup.number)} ${escapeHtml(backup.name)}${this.getPlayerStatus(backup) ? ' [' + escapeHtml(this.getPlayerStatus(backup)) + ']' : ''}">
                      #${escapeHtml(backup.number)} ${escapeHtml(this.getPlayerLastName(backup.name))}
                    </div>
                  ` : ''}
                  ${!this.twoDeepView && player.url ? `<a href="${safeUrl(player.url)}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()" class="inline-block mt-1 text-white/70 hover:text-white" title="View player page">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                  </a>` : ''}
                </div>
              ` : `
                <div class="px-2 py-3 text-center">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mx-auto opacity-50">
                    <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                  </svg>
                </div>
              `}
            </div>
          </div>
        `;
      }

      renderMobilePosition(pos, index) {
        const posKey = pos.isRight ? `${pos.code}-R` : pos.code;
        const player = this.depthChart[posKey]?.[this.twoDeepView ? 0 : this.depthLevel];
        const backup = this.twoDeepView ? this.depthChart[posKey]?.[1] : null;
        const status = player ? this.getPlayerStatus(player) : null;
        const note = player ? this.getPlayerNote(player) : '';
        const isBattle = this.positionBattles[posKey];
        const backupStatus = backup ? this.getPlayerStatus(backup) : null;
        const backupNote = backup ? this.getPlayerNote(backup) : '';

        return `
          <div class="border-b border-gray-200 dark:border-gray-700">
            <!-- Starter Row -->
            <div
              class="flex items-center p-3 ${!this.readOnlyMode ? 'cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700' : ''} transition-colors"
              ${!this.readOnlyMode ? `onclick="app.selectedSlot = { position: '${posKey}', depth: ${this.twoDeepView ? 0 : this.depthLevel} }; app.showPlayerModal = true; app.render()"` : ''}
            >
              <div class="w-16 flex-shrink-0">
                <div class="text-white text-center py-1 px-2 rounded font-display font-bold text-sm relative" style="background: ${this.team.primaryColor};">
                  ${pos.name}
                  ${isBattle ? `<span class="absolute -top-1 -right-1 text-[8px] bg-yellow-400 text-yellow-900 px-1 rounded font-bold">OR</span>` : ''}
                </div>
              </div>
              <div class="flex-1 ml-3">
                <div class="text-xs text-gray-500 dark:text-gray-400 mb-0.5">${pos.fullName}</div>
                ${player ? `
                  <div class="flex items-center gap-2">
                    <div class="w-8 h-8 text-white rounded-full flex items-center justify-center text-xs font-bold relative" style="background: ${this.team.primaryColor};">
                      ${escapeHtml(this.getPlayerInitials(player.name))}
                      ${status ? `<span class="absolute -top-1 -right-1 px-1 py-0.5 text-[7px] font-bold text-white rounded ${this.getStatusColor(status)}">${escapeHtml(this.getStatusBadge(status))}</span>` : ''}
                    </div>
                    <div class="flex-1 min-w-0">
                      <div class="font-semibold text-gray-900 dark:text-white text-sm flex items-center gap-1 flex-wrap">
                        <span>#${escapeHtml(player.number)} ${escapeHtml(player.name)}</span>
                        ${note ? `<span class="text-yellow-500" title="${escapeHtml(note)}">
                          <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M12 20h9M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                        </span>` : ''}
                        ${status ? `<span class="text-[10px] px-1.5 py-0.5 rounded ${this.getStatusColor(status)} text-white">${escapeHtml(status)}</span>` : ''}
                      </div>
                      <div class="text-xs text-gray-500 dark:text-gray-400">${escapeHtml(player.year)}${player.height ? ` ‚Ä¢ ${escapeHtml(player.height)}` : ''}${player.weight ? ` ‚Ä¢ ${escapeHtml(player.weight)}` : ''}</div>
                    </div>
                    ${player.url ? `<a href="${safeUrl(player.url)}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()" class="p-1 text-gray-400 hover:text-gray-600 flex-shrink-0">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                    </a>` : ''}
                  </div>
                ` : `
                  <div class="flex items-center gap-2 text-gray-400">
                    ${!this.readOnlyMode ? `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    <span class="text-sm">Tap to assign</span>` : `<span class="text-sm italic">Empty</span>`}
                  </div>
                `}
              </div>
            </div>

            <!-- Backup Row (Two-Deep View) -->
            ${this.twoDeepView ? `
              <div
                class="flex items-center p-2 pl-6 ${!this.readOnlyMode ? 'cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700' : ''} bg-gray-50 dark:bg-gray-750 transition-colors border-t border-gray-100 dark:border-gray-700"
                ${!this.readOnlyMode ? `onclick="app.selectedSlot = { position: '${posKey}', depth: 1 }; app.showPlayerModal = true; app.render()"` : ''}
              >
                <div class="w-10 flex-shrink-0">
                  <div class="text-gray-500 dark:text-gray-400 text-center py-0.5 px-1 rounded text-[10px] font-bold bg-gray-200 dark:bg-gray-600">
                    2nd
                  </div>
                </div>
                <div class="flex-1 ml-2">
                  ${backup ? `
                    <div class="flex items-center gap-2">
                      <div class="w-6 h-6 text-white rounded-full flex items-center justify-center text-[10px] font-bold relative" style="background: ${this.team.primaryColor}80;">
                        ${escapeHtml(this.getPlayerInitials(backup.name))}
                      </div>
                      <div class="flex-1 min-w-0">
                        <div class="text-gray-700 dark:text-gray-300 text-xs flex items-center gap-1 flex-wrap">
                          <span>#${escapeHtml(backup.number)} ${escapeHtml(backup.name)}</span>
                          ${backupNote ? `<span class="text-yellow-500" title="${escapeHtml(backupNote)}">
                            <svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><path d="M12 20h9M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                          </span>` : ''}
                          ${backupStatus ? `<span class="text-[9px] px-1 py-0.5 rounded ${this.getStatusColor(backupStatus)} text-white">${escapeHtml(backupStatus)}</span>` : ''}
                        </div>
                      </div>
                      ${backup.url ? `<a href="${safeUrl(backup.url)}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()" class="p-1 text-gray-400 hover:text-gray-600 flex-shrink-0">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                      </a>` : ''}
                    </div>
                  ` : `
                    <div class="flex items-center gap-2 text-gray-400">
                      ${!this.readOnlyMode ? `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                      <span class="text-xs">Tap to assign backup</span>` : `<span class="text-xs italic">Empty</span>`}
                    </div>
                  `}
                </div>
              </div>
            ` : ''}
          </div>
        `;
      }

      renderKeyboardHints() {
        return `
          <div class="mt-4 text-center text-gray-500 dark:text-gray-400 text-sm no-print">
            <span class="inline-flex items-center gap-4 flex-wrap justify-center">
              <span><kbd class="px-2 py-1 bg-white/10 rounded text-xs">‚Üê‚Üí</kbd> Tabs</span>
              <span><kbd class="px-2 py-1 bg-white/10 rounded text-xs">‚Üë‚Üì</kbd> Depth</span>
              <span><kbd class="px-2 py-1 bg-white/10 rounded text-xs">Ctrl+Z</kbd> Undo</span>
              <span><kbd class="px-2 py-1 bg-white/10 rounded text-xs">D</kbd> Dark</span>
            </span>
          </div>
        `;
      }

      renderPlayerModal() {
        if (!this.selectedSlot) return '';

        const { position, depth } = this.selectedSlot;
        const availablePlayers = this.getAvailablePlayers(position);
        const currentPlayer = this.depthChart[position]?.[depth];

        const allPositions = [...POSITIONS.offense, ...POSITIONS.defense, ...POSITIONS.special];
        const posInfo = allPositions.find(p => {
          const key = p.isRight ? `${p.code}-R` : p.code;
          return key === position;
        });

        return `
          <div class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4" onclick="if(event.target === this) { app.showPlayerModal = false; app.selectedSlot = null; app.searchQuery = ''; app.render(); }">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full max-h-[80vh] overflow-hidden flex flex-col">
              <div class="p-4 border-b dark:border-gray-700 flex items-center justify-between text-white" style="background: ${this.team.primaryColor};">
                <div>
                  <h2 class="font-display text-xl font-bold">${posInfo?.fullName || position}</h2>
                  <p class="text-sm text-white/70">${depth === 0 ? 'Starter' : `${depth + 1}${depth === 1 ? 'nd' : 'rd'} String`}</p>
                </div>
                <button onclick="app.showPlayerModal = false; app.selectedSlot = null; app.searchQuery = ''; app.render()" class="text-white/80 hover:text-white p-1" aria-label="Close player selection">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
              </div>

              <div class="p-4 border-b dark:border-gray-700">
                <div class="relative">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                  <input type="text" id="playerSearch" placeholder="Search by name or number‚Ä¶" class="w-full pl-10 pr-4 py-2 border-2 border-gray-200 dark:border-gray-600 rounded-lg focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" value="${escapeHtml(this.searchQuery)}"/>
                </div>
              </div>

              <div class="p-4 overflow-y-auto flex-1">
                <!-- Position Battle Toggle -->
                <div class="mb-4 flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg border dark:border-gray-600">
                  <div>
                    <div class="font-semibold text-gray-900 dark:text-white text-sm">Position Battle</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">Mark as "OR" (undecided starter)</div>
                  </div>
                  <button
                    onclick="app.togglePositionBattle('${position}')"
                    class="px-3 py-1.5 rounded-lg font-semibold text-sm transition-colors ${this.positionBattles[position] ? 'bg-yellow-400 text-yellow-900' : 'bg-gray-200 dark:bg-gray-600 text-gray-600 dark:text-gray-300'}"
                  >
                    ${this.positionBattles[position] ? '‚úì OR' : 'Set OR'}
                  </button>
                </div>

                ${currentPlayer ? `
                  <div class="mb-4 p-4 rounded-lg border" style="background: ${this.team.primaryColor}10; border-color: ${this.team.primaryColor}30;">
                    <div class="text-xs font-semibold mb-2 uppercase tracking-wide" style="color: ${this.team.primaryColor};">Current Player</div>
                    <div class="flex items-center gap-3 mb-3">
                      <div class="w-12 h-12 text-white rounded-full flex items-center justify-center font-bold text-lg relative" style="background: ${this.team.primaryColor};">
                        ${escapeHtml(this.getPlayerInitials(currentPlayer.name))}
                        ${this.getPlayerStatus(currentPlayer) ? `<span class="absolute -top-1 -right-1 px-1 text-[8px] font-bold text-white rounded ${this.getStatusColor(this.getPlayerStatus(currentPlayer))}">${escapeHtml(this.getStatusBadge(this.getPlayerStatus(currentPlayer)))}</span>` : ''}
                      </div>
                      <div class="flex-1">
                        <div class="font-bold text-gray-900 dark:text-white">
                          #${escapeHtml(currentPlayer.number)}
                          ${currentPlayer.url ? `<a href="${safeUrl(currentPlayer.url)}" target="_blank" rel="noopener noreferrer" class="hover:underline">${escapeHtml(currentPlayer.name)}</a>` : escapeHtml(currentPlayer.name)}
                        </div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">${escapeHtml(currentPlayer.year)}${currentPlayer.height ? ` ‚Ä¢ ${escapeHtml(currentPlayer.height)}` : ''}${currentPlayer.weight ? ` ‚Ä¢ ${escapeHtml(currentPlayer.weight)}` : ''}</div>
                        ${currentPlayer.hometown ? `<div class="text-xs text-gray-500">${escapeHtml(currentPlayer.hometown)}</div>` : ''}
                      </div>
                      <button onclick="app.removePlayer('${position}', ${depth})" class="p-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg" title="Remove" aria-label="Remove player">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                      </button>
                    </div>

                    <!-- Status Dropdown -->
                    <div class="mb-3">
                      <label class="block text-xs font-semibold text-gray-600 dark:text-gray-400 mb-1">Status / Availability</label>
                      <select
                        onchange="app.setPlayerStatus(${JSON.stringify(currentPlayer).replace(/"/g, '&quot;')}, this.value || null)"
                        class="w-full px-3 py-2 text-sm border border-gray-200 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                      >
                        <option value="" ${!this.getPlayerStatus(currentPlayer) ? 'selected' : ''}>Active / Healthy</option>
                        <option value="PROBABLE" ${this.getPlayerStatus(currentPlayer) === 'PROBABLE' ? 'selected' : ''}>Probable</option>
                        <option value="QUESTIONABLE" ${this.getPlayerStatus(currentPlayer) === 'QUESTIONABLE' ? 'selected' : ''}>Questionable</option>
                        <option value="DOUBTFUL" ${this.getPlayerStatus(currentPlayer) === 'DOUBTFUL' ? 'selected' : ''}>Doubtful</option>
                        <option value="OUT" ${this.getPlayerStatus(currentPlayer) === 'OUT' ? 'selected' : ''}>Out (Injured)</option>
                        <option value="SUSPENDED" ${this.getPlayerStatus(currentPlayer) === 'SUSPENDED' ? 'selected' : ''}>Suspended</option>
                        <option value="PORTAL" ${this.getPlayerStatus(currentPlayer) === 'PORTAL' ? 'selected' : ''}>Transfer Portal</option>
                        <option value="REDSHIRT" ${this.getPlayerStatus(currentPlayer) === 'REDSHIRT' ? 'selected' : ''}>Redshirt</option>
                      </select>
                    </div>

                    <!-- Notes -->
                    <div>
                      <label class="block text-xs font-semibold text-gray-600 dark:text-gray-400 mb-1">Notes</label>
                      <input
                        type="text"
                        placeholder="e.g., Breakout candidate, Coming off ACL..."
                        value="${escapeHtml(this.getPlayerNote(currentPlayer))}"
                        onchange="app.setPlayerNote(${JSON.stringify(currentPlayer).replace(/"/g, '&quot;')}, this.value)"
                        class="w-full px-3 py-2 text-sm border border-gray-200 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                      />
                    </div>
                  </div>
                ` : ''}

                ${availablePlayers.length === 0 ? this.renderEmptyPlayerState(position) : `
                  <div class="space-y-2">
                    ${availablePlayers.map((player, i) => `
                      <button
                        onclick="app.addPlayer('${position}', ${depth}, ${JSON.stringify({name: player.name, number: player.number, position: player.position, year: player.year, height: player.height, weight: player.weight, hometown: player.hometown, highSchool: player.highSchool, previousSchool: player.previousSchool, url: player.url}).replace(/"/g, '&quot;')})"
                        class="w-full text-left ${player.isAssigned ? 'bg-gray-100 dark:bg-gray-800 opacity-60' : 'bg-gray-50 dark:bg-gray-700'} hover:bg-gray-100 dark:hover:bg-gray-600 hover:opacity-100 border border-gray-200 dark:border-gray-600 rounded-lg p-3 transition-all"
                      >
                        <div class="flex items-center gap-3">
                          <div class="w-10 h-10 ${player.isAssigned ? 'bg-gray-300 dark:bg-gray-700' : 'bg-gray-200 dark:bg-gray-600'} rounded-full flex items-center justify-center text-gray-600 dark:text-gray-300 text-sm font-semibold">
                            ${escapeHtml(this.getPlayerInitials(player.name))}
                          </div>
                          <div class="flex-1">
                            <div class="font-semibold ${player.isAssigned ? 'text-gray-600 dark:text-gray-400' : 'text-gray-900 dark:text-white'}">#${escapeHtml(player.number)} ${escapeHtml(player.name)}</div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">${escapeHtml(player.position)} ‚Ä¢ ${escapeHtml(player.year)}${player.height ? ` ‚Ä¢ ${escapeHtml(player.height)}` : ''}${player.weight ? ` ‚Ä¢ ${escapeHtml(player.weight)}` : ''}</div>
                            ${player.isAssigned ? `<div class="text-xs text-amber-600 dark:text-amber-400 mt-1">Currently: ${escapeHtml(player.assignments.map(a => this.getSlotDisplayName(a.position) + ' #' + (a.depth + 1)).join(', '))}</div>` : ''}
                            ${!player.isAssigned && player.hometown ? `<div class="text-xs text-gray-400 dark:text-gray-500">${escapeHtml(player.hometown)}${player.previousSchool ? ` (${escapeHtml(player.previousSchool)})` : ''}</div>` : ''}
                          </div>
                          ${player.url ? `<a href="${safeUrl(player.url)}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()" class="p-1 text-gray-400 hover:text-gray-600" title="View profile">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                          </a>` : ''}
                        </div>
                      </button>
                    `).join('')}
                  </div>
                `}
              </div>
            </div>
          </div>
        `;
      }

      renderEmptyPlayerState(position) {
        if (this.searchQuery) {
          return `
            <div class="text-center py-8">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="mx-auto text-gray-300 dark:text-gray-600 mb-3"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
              <p class="text-gray-500 dark:text-gray-400 font-semibold">No players match "${escapeHtml(this.searchQuery)}"</p>
              <p class="text-gray-400 dark:text-gray-500 text-sm mt-1">Try a different search term</p>
            </div>
          `;
        }

        // Determine what positions would match this slot
        const posBase = position.replace('-R', '').replace(/-\d+$/, '');
        const positionNames = {
          'QB': 'Quarterback (QB)',
          'RB': 'Running Back (RB)',
          'FB': 'Fullback (FB, RB)',
          'WR': 'Wide Receiver (WR)',
          'TE': 'Tight End (TE)',
          'OT': 'Offensive Tackle (OL, OT)',
          'OG': 'Offensive Guard (OL, OG)',
          'C': 'Center (OL, C)',
          'DE': 'Defensive End (DE, DL, EDGE)',
          'DT': 'Defensive Tackle (DT, DL, NT)',
          'LB': 'Linebacker (LB, ILB, OLB, MLB)',
          'CB': 'Cornerback (CB, DB)',
          'S': 'Safety (S, FS, SS)',
          'K': 'Kicker (K, PK)',
          'P': 'Punter (P)',
          'LS': 'Long Snapper (LS, SNP)'
        };

        const expectedPositions = positionNames[posBase] || posBase;
        const stats = this.getRosterStats();
        const rosterTotal = this.roster.length;

        // Check if all players are already assigned
        const allAssigned = [];
        Object.values(this.depthChart).forEach(depthArray => {
          depthArray.forEach(player => {
            if (player) allAssigned.push(player);
          });
        });

        // Get players that match this position (before filtering out assigned)
        let matchingPos = posBase;
        if (posBase.startsWith('WR')) matchingPos = 'WR';
        else if (posBase.startsWith('TE')) matchingPos = 'TE';
        else if (posBase.startsWith('RB') || posBase === 'FB') matchingPos = 'RB';
        else if (['OT', 'OG', 'C'].includes(posBase)) matchingPos = 'OL';
        else if (posBase.startsWith('CB')) matchingPos = 'CB';
        else if (posBase.startsWith('S-')) matchingPos = 'S';
        else if (posBase.startsWith('LB')) matchingPos = 'LB';
        else if (posBase.startsWith('DE')) matchingPos = 'DE';
        else if (posBase.startsWith('DT')) matchingPos = 'DT';

        const matchingPlayers = this.roster.filter(p => {
          if (matchingPos === 'DE' || matchingPos === 'DT') {
            return ['DE', 'DT', 'DL', 'EDGE', 'NT'].includes(p.position);
          }
          if (matchingPos === 'OL') {
            return ['OL', 'OT', 'OG', 'C'].includes(p.position);
          }
          if (matchingPos === 'CB') {
            return ['CB', 'DB'].includes(p.position);
          }
          if (matchingPos === 'S') {
            return ['S', 'SS', 'FS', 'DB'].includes(p.position);
          }
          if (matchingPos === 'RB') {
            return ['RB', 'FB'].includes(p.position);
          }
          return p.position === matchingPos;
        });

        const assignedCount = matchingPlayers.filter(p =>
          allAssigned.some(a => a.number === p.number && a.name === p.name)
        ).length;

        if (rosterTotal === 0) {
          return `
            <div class="text-center py-8">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="mx-auto text-amber-400 mb-3"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>
              <p class="text-gray-700 dark:text-gray-300 font-semibold">No roster imported</p>
              <p class="text-gray-500 dark:text-gray-400 text-sm mt-1">Import a roster to start adding players</p>
              <button onclick="app.showPlayerModal = false; app.showImportModal = true; app.render()" class="mt-3 px-4 py-2 text-white rounded-lg text-sm font-semibold" style="background: ${this.team.primaryColor};">
                Import Roster
              </button>
            </div>
          `;
        }

        if (matchingPlayers.length === 0) {
          return `
            <div class="text-center py-8">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="mx-auto text-amber-400 mb-3"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
              <p class="text-gray-700 dark:text-gray-300 font-semibold">No ${expectedPositions} in roster</p>
              <p class="text-gray-500 dark:text-gray-400 text-sm mt-1">Your roster doesn't have players with matching positions</p>
              <div class="mt-3 p-3 bg-gray-100 dark:bg-gray-700 rounded-lg text-left text-sm">
                <p class="text-gray-600 dark:text-gray-400 mb-2">Players need one of these positions:</p>
                <p class="font-mono text-xs text-gray-500">${expectedPositions}</p>
              </div>
            </div>
          `;
        }

        if (assignedCount === matchingPlayers.length) {
          return `
            <div class="text-center py-8">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="mx-auto text-green-500 mb-3"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
              <p class="text-gray-700 dark:text-gray-300 font-semibold">All ${matchingPos} players assigned!</p>
              <p class="text-gray-500 dark:text-gray-400 text-sm mt-1">${assignedCount} of ${matchingPlayers.length} players are on the depth chart</p>
            </div>
          `;
        }

        return `
          <div class="text-center py-8">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="mx-auto text-gray-300 dark:text-gray-600 mb-3"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
            <p class="text-gray-500 dark:text-gray-400">No available players for this position</p>
          </div>
        `;
      }

      renderImportModal() {
        return `
          <div class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4" onclick="if(event.target === this) { app.showImportModal = false; app.importText = ''; app.importMessage = ''; app.render(); }">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-hidden flex flex-col">
              <div class="p-4 border-b dark:border-gray-700 flex items-center justify-between text-white" style="background: ${this.team.primaryColor};">
                <h2 class="font-display text-xl font-bold">Import Roster</h2>
                <button onclick="app.showImportModal = false; app.importText = ''; app.importMessage = ''; app.render()" class="text-white/80 hover:text-white" aria-label="Close import modal">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
              </div>

              <div class="p-4 overflow-y-auto flex-1">
                <div class="mb-4">
                  <p class="text-sm text-gray-700 dark:text-gray-300 mb-2">Paste roster data below. Each line should contain:</p>
                  <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-lg text-sm font-mono text-gray-800 dark:text-gray-200 mb-2">#19 Jack Lambert QB RJr</div>
                  <p class="text-xs text-gray-500 dark:text-gray-400">Format: #Number Name Position Year (or commas)</p>
                </div>

                <textarea id="importTextarea" placeholder="Paste roster data here‚Ä¶" class="w-full h-64 p-3 border-2 border-gray-200 dark:border-gray-600 rounded-lg font-mono text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white">${escapeHtml(this.importText)}</textarea>

                ${this.importMessage ? `
                  <div class="mt-3 p-3 rounded-lg ${this.importMessage.includes('Success') ? 'bg-green-50 dark:bg-green-900/30 text-green-800 dark:text-green-300' : 'bg-red-50 dark:bg-red-900/30 text-red-800 dark:text-red-300'}">
                    ${escapeHtml(this.importMessage)}
                  </div>
                ` : ''}
              </div>

              <div class="p-4 border-t dark:border-gray-700 bg-gray-50 dark:bg-gray-900 flex gap-3">
                <button onclick="app.importRoster()" class="flex-1 text-white px-4 py-3 rounded-lg font-display font-semibold" style="background: ${this.team.primaryColor};">
                  Import Roster
                </button>
                <button onclick="app.showImportModal = false; app.importText = ''; app.importMessage = ''; app.render()" class="px-4 py-3 bg-white dark:bg-gray-800 border-2 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-white rounded-lg font-semibold">
                  Cancel
                </button>
              </div>
            </div>
          </div>
        `;
      }

      renderResetModal() {
        return `
          <div class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4" onclick="if(event.target === this) { app.showResetModal = false; app.render(); }">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full overflow-hidden">
              <div class="p-6 text-center">
                <div class="w-16 h-16 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
                  <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-red-500">
                    <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
                  </svg>
                </div>
                <h2 class="font-display text-2xl font-bold text-gray-900 dark:text-white mb-2">Reset Depth Chart?</h2>
                <p class="text-gray-600 dark:text-gray-400 mb-6">This will remove all player assignments. You can undo with Ctrl+Z.</p>
                <div class="flex gap-3">
                  <button onclick="app.showResetModal = false; app.render()" class="flex-1 px-4 py-3 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg font-semibold hover:bg-gray-200 dark:hover:bg-gray-600">Cancel</button>
                  <button onclick="app.confirmReset()" class="flex-1 px-4 py-3 bg-red-500 hover:bg-red-600 text-white rounded-lg font-semibold">Reset</button>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      renderAppResetModal() {
        return `
          <div class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4" onclick="if(event.target === this) { app.showAppResetModal = false; app.render(); }">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full overflow-hidden">
              <div class="p-6 text-center">
                <div class="w-16 h-16 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
                  <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-red-500">
                    <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
                  </svg>
                </div>
                <h2 class="font-display text-2xl font-bold text-gray-900 dark:text-white mb-2">Reset Entire App?</h2>
                <p class="text-gray-600 dark:text-gray-400 mb-6">This will clear all data including your roster and depth chart. The app will return to its initial setup state.</p>
                <div class="flex gap-3">
                  <button onclick="app.showAppResetModal = false; app.render()" class="flex-1 px-4 py-3 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg font-semibold hover:bg-gray-200 dark:hover:bg-gray-600">Cancel</button>
                  <button onclick="app.confirmAppReset()" class="flex-1 px-4 py-3 bg-red-500 hover:bg-red-600 text-white rounded-lg font-semibold">Reset App</button>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      renderDepthReorderModal() {
        if (!this.selectedPositionGroup) return '';

        const group = this.selectedPositionGroup;
        const players = this.getPlayersForGroup(group);
        const slots = this.getDepthSlotsForGroup(group);

        // Get all players assigned to ANY position with their assignments
        const assignedMap = new Map();
        Object.entries(this.depthChart).forEach(([pos, depthArray]) => {
          depthArray?.forEach((player, depth) => {
            if (player) {
              const key = `${player.number}-${player.name}`;
              if (!assignedMap.has(key)) {
                assignedMap.set(key, []);
              }
              assignedMap.get(key).push({ position: pos, depth });
            }
          });
        });

        // Mark players with their assigned status and sort unassigned first
        const allPlayers = players.map(p => {
          const key = `${p.number}-${p.name}`;
          const assignments = assignedMap.get(key) || [];
          return {
            ...p,
            isAssigned: assignments.length > 0,
            assignments: assignments
          };
        }).sort((a, b) => {
          if (a.isAssigned && !b.isAssigned) return 1;
          if (!a.isAssigned && b.isAssigned) return -1;
          return 0;
        });

        const unassignedCount = allPlayers.filter(p => !p.isAssigned).length;

        return `
          <div class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4" onclick="if(event.target === this) { app.showDepthReorderModal = false; app.selectedPositionGroup = null; app.render(); }">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
              <div class="p-4 border-b dark:border-gray-700 flex items-center justify-between text-white" style="background: ${this.team.primaryColor};">
                <div>
                  <h2 class="font-display text-xl font-bold">${group} Depth Chart</h2>
                  <p class="text-sm text-white/70">${players.length} players in roster</p>
                </div>
                <button onclick="app.showDepthReorderModal = false; app.selectedPositionGroup = null; app.render()" class="text-white/80 hover:text-white p-1" aria-label="Close depth reorder">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
              </div>

              <div class="p-4 overflow-y-auto flex-1">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  <!-- Position Slots -->
                  <div class="flex flex-col">
                    <h3 class="font-display font-bold text-gray-900 dark:text-white mb-3 flex items-center gap-2">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                      Depth Chart Slots
                    </h3>
                    <div class="space-y-4 max-h-96 overflow-y-auto pr-2 scrollbar-thin border dark:border-gray-700 rounded-lg p-3 bg-gray-50 dark:bg-gray-900/50">
                      ${slots.map(slot => `
                        <div class="border dark:border-gray-700 rounded-lg overflow-hidden">
                          <div class="px-3 py-2 text-sm font-semibold text-white" style="background: ${this.team.primaryColor};">
                            ${slot.name}
                          </div>
                          <div class="divide-y dark:divide-gray-700">
                            ${[0, 1, 2].slice(0, slot.depth).map(d => {
                              const player = this.depthChart[slot.key]?.[d];
                              return `
                                <div class="p-2 flex items-center gap-2 ${player ? 'bg-gray-50 dark:bg-gray-700/50' : 'bg-white dark:bg-gray-800'}">
                                  <span class="w-6 h-6 rounded-full text-xs font-bold flex items-center justify-center ${d === 0 ? 'bg-yellow-400 text-yellow-900' : d === 1 ? 'bg-gray-300 text-gray-700' : 'bg-amber-600 text-white'}">
                                    ${d + 1}
                                  </span>
                                  ${player ? `
                                    <div class="flex-1">
                                      <span class="font-semibold text-gray-900 dark:text-white text-sm">#${escapeHtml(player.number)} ${escapeHtml(player.name)}</span>
                                      <span class="text-xs text-gray-500 dark:text-gray-400 ml-2">${escapeHtml(player.year || '')}</span>
                                    </div>
                                    <button onclick="app.removeFromReorder('${slot.key}', ${d})" class="p-1 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded" title="Remove" aria-label="Remove player">
                                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                                    </button>
                                  ` : `
                                    <span class="flex-1 text-gray-400 dark:text-gray-500 text-sm italic">Empty - select from available players</span>
                                  `}
                                </div>
                              `;
                            }).join('')}
                          </div>
                        </div>
                      `).join('')}
                    </div>
                  </div>

                  <!-- Available Players -->
                  <div class="flex flex-col">
                    <h3 class="font-display font-bold text-gray-900 dark:text-white mb-3 flex items-center gap-2">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
                      Players (${unassignedCount} available, ${allPlayers.length - unassignedCount} assigned)
                    </h3>
                    ${allPlayers.length === 0 ? `
                      <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                        <p class="font-semibold">No ${group} players in roster</p>
                      </div>
                    ` : `
                      <div class="space-y-2 max-h-96 overflow-y-auto pr-2 scrollbar-thin border dark:border-gray-700 rounded-lg p-3 bg-gray-50 dark:bg-gray-900/50">
                        ${allPlayers.map(player => `
                          <div class="border dark:border-gray-700 rounded-lg p-3 ${player.isAssigned ? 'bg-gray-100 dark:bg-gray-800 opacity-60' : 'bg-gray-50 dark:bg-gray-700/50'} hover:opacity-100 transition-opacity">
                            <div class="flex items-center gap-3 mb-2">
                              <div class="w-10 h-10 rounded-full flex items-center justify-center text-white text-sm font-bold ${player.isAssigned ? 'opacity-70' : ''}" style="background: ${this.team.primaryColor};">
                                ${escapeHtml(this.getPlayerInitials(player.name))}
                              </div>
                              <div class="flex-1">
                                <div class="font-semibold ${player.isAssigned ? 'text-gray-600 dark:text-gray-400' : 'text-gray-900 dark:text-white'}">#${escapeHtml(player.number)} ${escapeHtml(player.name)}</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">${escapeHtml(player.position)} ‚Ä¢ ${escapeHtml(player.year)}${player.height ? ` ‚Ä¢ ${escapeHtml(player.height)}` : ''}${player.weight ? ` ‚Ä¢ ${escapeHtml(player.weight)}` : ''}</div>
                                ${player.isAssigned ? `<div class="text-xs text-amber-600 dark:text-amber-400 mt-1">Currently: ${escapeHtml(player.assignments.map(a => this.getSlotDisplayName(a.position) + ' #' + (a.depth + 1)).join(', '))}</div>` : ''}
                              </div>
                            </div>
                            <div class="flex flex-wrap gap-1">
                              ${slots.map(slot => `
                                ${[0, 1, 2].slice(0, slot.depth).map(d => {
                                  const occupied = this.depthChart[slot.key]?.[d];
                                  // Show button if slot is empty OR if this player isn't already in this exact slot
                                  const isThisPlayerInSlot = occupied && occupied.number === player.number && occupied.name === player.name;
                                  return !isThisPlayerInSlot ? `
                                    <button
                                      onclick="app.assignFromReorder('${slot.key}', ${d}, ${JSON.stringify({name: player.name, number: player.number, position: player.position, year: player.year, height: player.height, weight: player.weight, hometown: player.hometown, highSchool: player.highSchool, previousSchool: player.previousSchool, url: player.url}).replace(/"/g, '&quot;')})"
                                      class="px-2 py-1 text-xs rounded border hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors ${occupied ? 'border-dashed opacity-70' : ''}"
                                      style="border-color: ${this.team.primaryColor}; color: ${this.team.primaryColor};"
                                      title="${occupied ? 'Replace ' + escapeHtml(occupied.name) : ''}"
                                    >
                                      ${slot.name} #${d + 1}${occupied ? '*' : ''}
                                    </button>
                                  ` : '';
                                }).join('')}
                              `).join('')}
                            </div>
                          </div>
                        `).join('')}
                      </div>
                    `}
                  </div>
                </div>
              </div>

              <div class="p-4 border-t dark:border-gray-700 bg-gray-50 dark:bg-gray-900">
                <button onclick="app.showDepthReorderModal = false; app.selectedPositionGroup = null; app.render()" class="w-full py-2 text-white rounded-lg font-semibold" style="background: ${this.team.primaryColor};">
                  Done
                </button>
              </div>
            </div>
          </div>
        `;
      }

      handleTouchStart(e) {
        this.touchStartX = e.changedTouches[0].screenX;
        this.touchStartY = e.changedTouches[0].screenY;
      }

      handleTouchEnd(e) {
        this.touchEndX = e.changedTouches[0].screenX;
        this.touchEndY = e.changedTouches[0].screenY;
        this.handleSwipeGesture();
      }

      handleSwipeGesture() {
        const deltaX = this.touchEndX - this.touchStartX;
        const deltaY = this.touchEndY - this.touchStartY;
        const minSwipeDistance = 50;

        // Only trigger if horizontal swipe is greater than vertical (not scrolling)
        if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > minSwipeDistance) {
          const tabs = ['offense', 'defense', 'special'];
          const currentIndex = tabs.indexOf(this.activeTab);

          if (deltaX < 0) {
            // Swipe left - go to next tab
            const nextIndex = (currentIndex + 1) % tabs.length;
            this.activeTab = tabs[nextIndex];
            this.render();
          } else {
            // Swipe right - go to previous tab
            const prevIndex = (currentIndex - 1 + tabs.length) % tabs.length;
            this.activeTab = tabs[prevIndex];
            this.render();
          }
        }
      }

      attachEventListeners() {
        // Swipe gesture listeners for mobile tab switching
        const mobileListView = document.querySelector('.mobile-list-view');
        if (mobileListView) {
          mobileListView.addEventListener('touchstart', (e) => this.handleTouchStart(e), { passive: true });
          mobileListView.addEventListener('touchend', (e) => this.handleTouchEnd(e), { passive: true });
        }

        const textarea = document.getElementById('importTextarea');
        if (textarea) {
          textarea.addEventListener('input', (e) => { this.importText = e.target.value; });
        }

        const setupTextarea = document.getElementById('setupRosterTextarea');
        if (setupTextarea) {
          setupTextarea.addEventListener('input', (e) => { this.importText = e.target.value; });
        }

        const colorInput = document.getElementById('teamColorInput');
        const colorText = document.getElementById('teamColorText');
        if (colorInput && colorText) {
          colorInput.addEventListener('input', (e) => { colorText.value = e.target.value; });
          colorText.addEventListener('input', (e) => { colorInput.value = e.target.value; });
        }

        const settingsColor = document.getElementById('settingsTeamColor');
        const settingsColorText = document.getElementById('settingsTeamColorText');
        if (settingsColor && settingsColorText) {
          settingsColor.addEventListener('input', (e) => { settingsColorText.value = e.target.value; });
          settingsColorText.addEventListener('input', (e) => { settingsColor.value = e.target.value; });
        }

        // URL input for roster import
        const urlInput = document.getElementById('rosterUrlInput');
        const commandOutput = document.getElementById('commandOutput');
        if (urlInput && commandOutput) {
          urlInput.addEventListener('input', (e) => {
            const url = e.target.value.trim();
            if (url) {
              commandOutput.value = `node scrape-roster.js "${url}" && node update-html.js`;
            } else {
              commandOutput.value = '';
            }
          });
        }

        const searchInput = document.getElementById('playerSearch');
        if (searchInput) {
          searchInput.addEventListener('input', (e) => {
            this.searchQuery = e.target.value;
            this.render();
            setTimeout(() => {
              const newInput = document.getElementById('playerSearch');
              if (newInput) {
                newInput.focus();
                newInput.setSelectionRange(newInput.value.length, newInput.value.length);
              }
            }, 0);
          });
          searchInput.focus();
        }
      }
    }

    const app = new DepthChartApp();
  </script>
</body>
</html>
